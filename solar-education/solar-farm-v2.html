<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ampacity Renewables ‚Äî 3D Solar Farm v2</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{overflow:hidden;background:#0a0a0a;font-family:'DM Sans',sans-serif}
  canvas{display:block}

  /* ‚ïê‚ïê‚ïê FULL-SCREEN SITE BUILDER MODAL ‚ïê‚ïê‚ïê */
  #modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,#0a0e1a 0%,#0d1220 40%,#0f1628 100%);transition:opacity .6s,transform .5s}
  #modal.hidden{opacity:0;pointer-events:none;transform:scale(1.02)}
  #modalInner{width:100%;max-width:880px;max-height:calc(100vh - 40px);overflow-y:auto;padding:0 24px 24px}

  /* Header */
  .modal-header{text-align:center;padding:28px 0 16px;position:relative}
  .modal-logo{font-size:22px;margin-bottom:2px}
  .modal-title{font-size:28px;font-weight:700;color:#E84868;letter-spacing:.02em}
  .modal-subtitle{font-size:13px;color:rgba(255,255,255,.4);margin-top:6px;font-family:'JetBrains Mono',monospace}
  .modal-close{position:absolute;right:0;top:28px;width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,.12);background:transparent;color:rgba(255,255,255,.4);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
  .modal-close:hover{border-color:rgba(255,255,255,.3);color:#fff;background:rgba(255,255,255,.06)}

  /* Step tabs */
  .step-tabs{display:flex;justify-content:center;gap:8px;margin:20px 0 28px;flex-wrap:wrap}
  .step-tab{display:flex;align-items:center;gap:6px;padding:7px 16px;border-radius:20px;font-size:12px;font-weight:500;color:rgba(255,255,255,.3);background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);transition:all .3s;font-family:'DM Sans',sans-serif}
  .step-tab .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.12);transition:all .3s}
  .step-tab.active{color:#fff;background:rgba(37,99,235,.2);border-color:rgba(37,99,235,.4)}
  .step-tab.active .dot{background:#3b82f6}
  .step-tab.done{color:rgba(255,255,255,.55)}
  .step-tab.done .dot{background:#22c55e}

  /* Sections */
  .cfg-section{margin-bottom:22px}
  .cfg-section-label{font-size:13px;font-weight:700;color:#E84868;text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:6px}
  .cfg-section-label span{color:rgba(255,255,255,.2);font-size:10px}

  /* Option cards */
  .cfg-cards{display:grid;gap:10px}
  .cfg-cards.cols-2{grid-template-columns:1fr 1fr}
  .cfg-cards.cols-3{grid-template-columns:1fr 1fr 1fr}
  .cfg-card{background:rgba(255,255,255,.03);border:1.5px solid rgba(255,255,255,.08);border-radius:10px;padding:14px 18px;cursor:pointer;transition:all .25s;user-select:none}
  .cfg-card:hover:not(.cfg-disabled){background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.16)}
  .cfg-card.cfg-selected{background:rgba(37,99,235,.15);border-color:rgba(37,99,235,.45);box-shadow:0 0 20px rgba(37,99,235,.08)}
  .cfg-card.cfg-disabled{opacity:.18;cursor:not-allowed;pointer-events:none}
  .cfg-card-title{font-size:14px;font-weight:600;color:rgba(255,255,255,.85);margin-bottom:3px}
  .cfg-card-sub{font-size:11px;color:rgba(255,255,255,.3);font-family:'JetBrains Mono',monospace}

  /* Footer */
  .modal-footer{display:flex;align-items:center;justify-content:space-between;padding-top:16px;border-top:1px solid rgba(255,255,255,.05);margin-top:6px}
  #sbStatus{font-size:13px;font-family:'JetBrains Mono',monospace;color:rgba(255,255,255,.3)}
  .modal-footer-right{display:flex;gap:10px;align-items:center}
  #startOverBtn{background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 18px;color:rgba(255,255,255,.4);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s}
  #startOverBtn:hover{border-color:rgba(255,255,255,.25);color:rgba(255,255,255,.7)}
  #buildBtn{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border:none;border-radius:8px;padding:8px 22px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;opacity:0;transform:scale(.95);transition:all .3s;pointer-events:none}
  #buildBtn.visible{opacity:1;transform:scale(1);pointer-events:auto}
  #buildBtn:hover{background:linear-gradient(135deg,#3b82f6,#2563eb);box-shadow:0 2px 16px rgba(37,99,235,.35)}

  /* ‚ïê‚ïê‚ïê 3D SCENE OVERLAYS ‚ïê‚ïê‚ïê */
  #ui{position:fixed;top:0;left:0;z-index:10;padding:20px;pointer-events:none;opacity:0;transition:opacity .8s}
  #ui.visible{opacity:1}
  #ui h1{font-size:15px;font-weight:700;color:#fff;letter-spacing:.08em;text-transform:uppercase;margin-bottom:4px;text-shadow:0 1px 8px rgba(0,0,0,.6)}
  #ui .sub{font-size:11px;color:rgba(255,255,255,.5);font-family:'JetBrains Mono',monospace;margin-bottom:16px;text-shadow:0 1px 4px rgba(0,0,0,.5)}
  #info{position:fixed;top:20px;right:20px;z-index:10;font-size:10px;color:rgba(255,255,255,.3);font-family:'JetBrains Mono',monospace;text-align:right;text-shadow:0 1px 4px rgba(0,0,0,.5);opacity:0;transition:opacity .8s}
  #info.visible{opacity:1}
  #legend{position:fixed;top:70px;right:20px;z-index:10;background:rgba(8,8,12,.88);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px 14px;font-family:'JetBrains Mono',monospace;min-width:210px;display:none}
  #legend.visible{display:block}
  #legend h3{font-size:9px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
  #legend h3 .leg-hide{background:none;border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.35);font-size:9px;padding:2px 6px;border-radius:4px;cursor:pointer;font-family:inherit;letter-spacing:.05em;transition:all .2s}
  #legend h3 .leg-hide:hover{border-color:rgba(255,255,255,.3);color:rgba(255,255,255,.6)}
  #legendToggle{position:fixed;top:70px;right:20px;z-index:10;background:rgba(8,8,12,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:7px 14px;color:rgba(255,255,255,.5);font-family:'DM Sans',sans-serif;font-size:11px;cursor:pointer;transition:all .25s;display:none}
  #legendToggle.visible{display:block}
  #legendToggle:hover{border-color:rgba(255,255,255,.25);color:#fff}
  .leg-item{display:flex;align-items:center;gap:8px;margin-bottom:5px}
  .leg-item:last-child{margin-bottom:0}
  .leg-color{width:24px;height:6px;border-radius:3px;flex-shrink:0}
  .leg-label{font-size:10px;color:rgba(255,255,255,.6);line-height:1.2}
  .leg-arrow{font-size:8px;color:rgba(255,255,255,.18);text-align:center;margin:2px 0 2px 4px}
  .leg-equip{font-size:8px;color:rgba(255,255,255,.3);padding:1px 6px;background:rgba(255,255,255,.03);border-radius:3px;margin-left:28px;margin-bottom:4px}

  /* Edit config button (shown during 3D view) */
  #editCfgBtn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;background:rgba(8,8,12,.85);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 22px;color:rgba(255,255,255,.55);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .25s;opacity:0;pointer-events:none}
  #editCfgBtn.visible{opacity:1;pointer-events:auto}
  #editCfgBtn:hover{border-color:rgba(255,255,255,.25);color:#fff;background:rgba(8,8,12,.92)}
  #nav{position:fixed;left:20px;top:90px;z-index:10;background:rgba(8,8,12,.88);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:0;font-family:'DM Sans',sans-serif;min-width:185px;max-width:205px;max-height:calc(100vh - 140px);opacity:0;pointer-events:none;transition:opacity .8s;overflow:hidden;display:flex;flex-direction:column}
  #nav.visible{opacity:1;pointer-events:auto}
  #nav h3{font-size:9px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.1em;margin:0;padding:10px 14px 6px;flex-shrink:0}
  #nav-list{overflow-y:auto;padding-bottom:6px;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
  .nav-btn{display:flex;align-items:center;gap:8px;width:100%;padding:7px 14px;border:none;background:transparent;color:rgba(255,255,255,.6);font-family:'DM Sans',sans-serif;font-size:11px;font-weight:500;cursor:pointer;transition:all .2s;text-align:left;border-left:2px solid transparent}
  .nav-btn:hover{background:rgba(255,255,255,.06);color:#fff;border-left-color:rgba(37,99,235,.5)}
  .nav-btn.active{background:rgba(37,99,235,.12);color:#fff;border-left-color:#2563EB}
  .nav-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .nav-sep{height:1px;background:rgba(255,255,255,.06);margin:2px 14px}

  /* Loading */
  #loading{position:fixed;inset:0;z-index:150;display:flex;align-items:center;justify-content:center;background:#0a0e1a;color:#fff;flex-direction:column;gap:12px;opacity:0;pointer-events:none;transition:opacity .4s}
  #loading.active{opacity:1;pointer-events:auto}
  .spinner{width:32px;height:32px;border:2px solid rgba(255,255,255,.1);border-top-color:#3b82f6;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #loading p{font-size:12px;color:rgba(255,255,255,.4);font-family:'JetBrains Mono',monospace}

  @media(max-width:700px){
    .cfg-cards.cols-3{grid-template-columns:1fr 1fr}
    .modal-title{font-size:22px}
  }
</style>
</head>
<body>

<a href="Ampacity_Renewables_Solar_Education.html" style="position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:9999; background:rgba(6,11,23,0.92); backdrop-filter:blur(10px); border:1px solid rgba(232,72,104,0.3); border-radius:8px; padding:8px 14px; color:#E84868; font-size:12px; font-weight:600; text-decoration:none; display:flex; align-items:center; gap:6px; transition:all 0.2s; font-family:'DM Sans',sans-serif;" onmouseover="this.style.borderColor='rgba(232,72,104,0.6)'; this.style.background='rgba(6,11,23,1)'; this.style.boxShadow='0 0 15px rgba(232,72,104,0.15)';" onmouseout="this.style.borderColor='rgba(232,72,104,0.3)'; this.style.background='rgba(6,11,23,0.92)'; this.style.boxShadow='none';">‚Üê Back to Education</a>

<!-- Full-screen site builder modal -->
<div id="modal">
  <div id="modalInner">
    <div class="modal-header">
      <div class="modal-logo">üèó</div>
      <div class="modal-title">Create a Site</div>
      <div class="modal-subtitle">Select your solar site configuration ‚Äî invalid options are automatically disabled</div>
      <button class="modal-close" id="modalCloseBtn">‚úï</button>
    </div>

    <div class="step-tabs">
      <div class="step-tab" id="st0"><span class="dot"></span> Module</div>
      <div class="step-tab" id="st1"><span class="dot"></span> Inverter</div>
      <div class="step-tab" id="st2"><span class="dot"></span> DC Collection</div>
      <div class="step-tab" id="st3"><span class="dot"></span> DC Combination</div>
    </div>

    <div class="cfg-section">
      <div class="cfg-section-label">‚ñ∏ Module / String Size</div>
      <div class="cfg-cards cols-2" data-field="module">
        <div class="cfg-card" data-value="bifacial-600">
          <div class="cfg-card-title">Bifacial 600W</div>
          <div class="cfg-card-sub">28 mods/string</div>
        </div>
        <div class="cfg-card" data-value="first-solar">
          <div class="cfg-card-title">First Solar 525W</div>
          <div class="cfg-card-sub">6 mods/string</div>
        </div>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-section-label">‚ñ∏ Inverter Type</div>
      <div class="cfg-cards cols-3" data-field="inverter">
        <div class="cfg-card" data-value="distributed">
          <div class="cfg-card-title">Distributed String Inverters</div>
          <div class="cfg-card-sub">Individual inverters per string</div>
        </div>
        <div class="cfg-card" data-value="centralized-cluster">
          <div class="cfg-card-title">Centralized String Inverter Clusters</div>
          <div class="cfg-card-sub">Grouped inverter clusters</div>
        </div>
        <div class="cfg-card" data-value="central">
          <div class="cfg-card-title">Central Inverters</div>
          <div class="cfg-card-sub">Single large central inverter</div>
        </div>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-section-label">‚ñ∏ DC Collection</div>
      <div class="cfg-cards cols-3" data-field="dcCollection">
        <div class="cfg-card" data-value="string-homeruns">
          <div class="cfg-card-title">String Homeruns</div>
          <div class="cfg-card-sub">Direct wire runs from each string</div>
        </div>
        <div class="cfg-card" data-value="harnesses">
          <div class="cfg-card-title">Harnesses</div>
          <div class="cfg-card-sub">Bundled cable assemblies</div>
        </div>
        <div class="cfg-card" data-value="trunk-bus">
          <div class="cfg-card-title">Trunk Bus</div>
          <div class="cfg-card-sub">High-capacity bus system</div>
        </div>
      </div>
    </div>

    <div class="cfg-section">
      <div class="cfg-section-label">‚ñ∏ DC Combination</div>
      <div class="cfg-cards cols-3" data-field="dcCombo">
        <div class="cfg-card" data-value="combiner-boxes">
          <div class="cfg-card-title">Combiner Boxes</div>
          <div class="cfg-card-sub">Combine multiple string outputs</div>
        </div>
        <div class="cfg-card" data-value="lbds">
          <div class="cfg-card-title">LBD's</div>
          <div class="cfg-card-sub">Load Break Disconnects</div>
        </div>
        <div class="cfg-card" data-value="none">
          <div class="cfg-card-title">None</div>
          <div class="cfg-card-sub">No DC combination needed</div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div id="sbStatus">0 of 4 selected</div>
      <div class="modal-footer-right">
        <button id="startOverBtn">‚Üª Start Over</button>
        <button id="buildBtn">Build Site ‚ñ∏</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading screen (between modal and 3D) -->
<div id="loading"><div class="spinner"></div><p>Building solar farm‚Ä¶</p></div>

<!-- 3D scene overlays (hidden until site is built) -->
<div id="ui"><h1>Ampacity Renewables</h1><div class="sub">3D Solar Farm ‚Äî Enhanced v2</div></div>
<div id="info">Orbit: drag ¬∑ Zoom: scroll ¬∑ Pan: right-drag ¬∑ Keys: ‚Üê ‚Üí cycle ¬∑ 1-9 jump</div>
<div id="legend"></div>
<button id="legendToggle">‚ö° Power Flow</button>
<button id="editCfgBtn">‚öô Edit Configuration</button>
<div id="nav"><h3>Navigate To ¬∑ ‚Üê ‚Üí keys</h3><div id="nav-list"></div></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê OrbitControls (inline) ‚ïê‚ïê‚ïê
THREE.OrbitControls=function(o,d){
  this.object=o;this.domElement=d;this.target=new THREE.Vector3();
  this.enableDamping=true;this.dampingFactor=.08;this.rotateSpeed=.5;this.zoomSpeed=1.2;this.panSpeed=.8;
  this.minDistance=3;this.maxDistance=500;this.maxPolarAngle=Math.PI/2-.02;
  var s=this,spherical=new THREE.Spherical(),sphericalDelta=new THREE.Spherical();
  var panOffset=new THREE.Vector3(),scale=1;
  var rotStart=new THREE.Vector2(),rotEnd=new THREE.Vector2(),rotDelta=new THREE.Vector2();
  var panStart=new THREE.Vector2(),panEnd=new THREE.Vector2(),panDelta=new THREE.Vector2();
  var STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},state=STATE.NONE;
  function getZoomScale(){return Math.pow(.95,s.zoomSpeed)}
  this.update=function(){
    var offset=new THREE.Vector3();
    var quat=new THREE.Quaternion().setFromUnitVectors(o.up,new THREE.Vector3(0,1,0));
    var quatInv=quat.clone().invert();
    return function(){
      var pos=s.object.position;offset.copy(pos).sub(s.target);offset.applyQuaternion(quat);
      spherical.setFromVector3(offset);
      spherical.theta+=sphericalDelta.theta*s.dampingFactor;
      spherical.phi+=sphericalDelta.phi*s.dampingFactor;
      spherical.phi=Math.max(.01,Math.min(s.maxPolarAngle,spherical.phi));
      spherical.radius*=scale;
      spherical.radius=Math.max(s.minDistance,Math.min(s.maxDistance,spherical.radius));
      s.target.addScaledVector(panOffset,s.dampingFactor);
      offset.setFromSpherical(spherical);offset.applyQuaternion(quatInv);
      pos.copy(s.target).add(offset);s.object.lookAt(s.target);
      sphericalDelta.theta*=(1-s.dampingFactor);sphericalDelta.phi*=(1-s.dampingFactor);
      panOffset.multiplyScalar(1-s.dampingFactor);scale=1;
    }
  }();
  function onMD(e){if(e.button===0){state=STATE.ROTATE;rotStart.set(e.clientX,e.clientY)}else if(e.button===2){state=STATE.PAN;panStart.set(e.clientX,e.clientY)}}
  function onMM(e){
    if(state===STATE.ROTATE){rotEnd.set(e.clientX,e.clientY);rotDelta.subVectors(rotEnd,rotStart);sphericalDelta.theta-=2*Math.PI*rotDelta.x/d.clientHeight*s.rotateSpeed;sphericalDelta.phi-=2*Math.PI*rotDelta.y/d.clientHeight*s.rotateSpeed;rotStart.copy(rotEnd)}
    else if(state===STATE.PAN){panEnd.set(e.clientX,e.clientY);panDelta.subVectors(panEnd,panStart);var te=new THREE.Vector3(),re=new THREE.Vector3();var dist=o.position.distanceTo(s.target);var fovH=2*Math.tan(o.fov/2*Math.PI/180)*dist;te.setFromMatrixColumn(o.matrix,0);re.setFromMatrixColumn(o.matrix,1);te.multiplyScalar(-panDelta.x*fovH/d.clientHeight*s.panSpeed);re.multiplyScalar(panDelta.y*fovH/d.clientHeight*s.panSpeed);panOffset.add(te).add(re);panStart.copy(panEnd)}
  }
  function onMU(){state=STATE.NONE}
  function onW(e){if(e.deltaY>0)scale/=getZoomScale();else scale*=getZoomScale()}
  d.addEventListener('mousedown',onMD);d.addEventListener('mousemove',onMM);d.addEventListener('mouseup',onMU);
  d.addEventListener('wheel',onW,{passive:true});d.addEventListener('contextmenu',e=>e.preventDefault());
  // Touch support
  var touchStart=new THREE.Vector2(),touchDist=0;
  d.addEventListener('touchstart',function(e){
    if(e.touches.length===1){state=STATE.ROTATE;rotStart.set(e.touches[0].clientX,e.touches[0].clientY)}
    else if(e.touches.length===2){state=STATE.ZOOM;var dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;touchDist=Math.sqrt(dx*dx+dy*dy)}
  },{passive:true});
  d.addEventListener('touchmove',function(e){
    if(state===STATE.ROTATE&&e.touches.length===1){rotEnd.set(e.touches[0].clientX,e.touches[0].clientY);rotDelta.subVectors(rotEnd,rotStart);sphericalDelta.theta-=2*Math.PI*rotDelta.x/d.clientHeight*s.rotateSpeed;sphericalDelta.phi-=2*Math.PI*rotDelta.y/d.clientHeight*s.rotateSpeed;rotStart.copy(rotEnd)}
    else if(state===STATE.ZOOM&&e.touches.length===2){var dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;var nd=Math.sqrt(dx*dx+dy*dy);if(nd>touchDist)scale*=getZoomScale();else scale/=getZoomScale();touchDist=nd}
  },{passive:true});
  d.addEventListener('touchend',function(){state=STATE.NONE},{passive:true});
};

// ‚ïê‚ïê‚ïê TEXTURE GENERATORS ‚ïê‚ïê‚ïê
function mkPanelTex(isBi,isFS){
  var c=document.createElement('canvas');c.width=256;c.height=512;var x=c.getContext('2d');
  if(isFS){
    // First Solar CdTe thin-film: uniform dark black, no cell grid, frameless
    var g=x.createLinearGradient(0,0,256,512);
    g.addColorStop(0,'#0e0e12');g.addColorStop(.3,'#111118');g.addColorStop(.7,'#0d0d14');g.addColorStop(1,'#0a0a10');
    x.fillStyle=g;x.fillRect(0,0,256,512);
    // Subtle micro-texture (CdTe film uniformity)
    for(var i=0;i<1200;i++){x.fillStyle='rgba('+(8+Math.random()*12)+','+(8+Math.random()*12)+','+(14+Math.random()*10)+','+(0.15+Math.random()*0.15)+')';x.fillRect(Math.random()*256,Math.random()*512,2+Math.random()*4,2+Math.random()*4)}
    // No silver cell grid ‚Äî thin film is continuous
    // Faint edge line (frameless glass)
    x.strokeStyle='rgba(60,65,75,.35)';x.lineWidth=1.5;x.strokeRect(1,1,254,510);
  }else{
    x.fillStyle=isBi?'#1a2244':'#14192e';x.fillRect(0,0,256,512);
    var cellW=256/6,cellH=512/10;
    for(var r=0;r<10;r++)for(var col=0;col<6;col++){
      var cx2=col*cellW+2,cy=r*cellH+2,cw=cellW-4,ch=cellH-4;
      var g2=x.createLinearGradient(cx2,cy,cx2+cw,cy+ch);
      if(isBi){g2.addColorStop(0,'#284078');g2.addColorStop(.5,'#3858A0');g2.addColorStop(1,'#2A4080')}
      else{g2.addColorStop(0,'#182040');g2.addColorStop(.5,'#1e2850');g2.addColorStop(1,'#182040')}
      x.fillStyle=g2;x.fillRect(cx2,cy,cw,ch);
      x.strokeStyle='rgba(100,120,180,.15)';x.lineWidth=.5;
      for(var l=0;l<4;l++){x.beginPath();x.moveTo(cx2,cy+l*(ch/3));x.lineTo(cx2+cw,cy+l*(ch/3));x.stroke()}
    }
    x.strokeStyle='rgba(180,180,180,.25)';x.lineWidth=1;x.strokeRect(2,2,252,508);
  }
  var t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearFilter;return t;
}
function mkGroundTex(){
  var c=document.createElement('canvas');c.width=512;c.height=512;var x=c.getContext('2d');
  x.fillStyle='#5a6b3a';x.fillRect(0,0,512,512);
  for(var i=0;i<8000;i++){var px=Math.random()*512,py=Math.random()*512;var sh=40+Math.random()*40;x.fillStyle='rgb('+(sh+20)+','+(sh+40)+','+sh+')';x.fillRect(px,py,1+Math.random()*2,1+Math.random()*2)}
  var t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(20,20);return t;
}
function mkGravelTex(){
  var c=document.createElement('canvas');c.width=256;c.height=256;var x=c.getContext('2d');
  x.fillStyle='#8a8070';x.fillRect(0,0,256,256);
  for(var i=0;i<3000;i++){var px=Math.random()*256,py=Math.random()*256;var s=100+Math.random()*60;x.fillStyle='rgb('+s+','+(s-5)+','+(s-10)+')';var r2=1+Math.random()*3;x.beginPath();x.arc(px,py,r2,0,Math.PI*2);x.fill()}
  var t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;return t;
}

// ‚ïê‚ïê‚ïê SITE BUILDER v2 ‚ïê‚ïê‚ïê
function svBuildSite(sc,inv,dc,comb,isBi,isFS){
  const R=()=>Math.random();
  const waypoints=[]; // Navigation waypoints for fly-to

  // ‚ïê‚ïê‚ïê REALISTIC TERRAIN ‚ïê‚ïê‚ïê
  const gG=new THREE.PlaneGeometry(800,800,80,80);
  const gP=gG.attributes.position;
  for(let i=0;i<gP.count;i++){
    const gx=gP.getX(i),gz=gP.getY(i);
    let elev=Math.sin(gx*.032)*Math.cos(gz*.042)*.45;
    elev+=Math.sin(gx*.085+gz*.075)*.18;
    elev+=Math.sin(gx*.52)*Math.cos(gz*.48)*.035;
    const dist=Math.sqrt(gx*gx+gz*gz);
    if(dist>100)elev-=(dist-100)*.002;
    gP.setZ(i,elev);
  }
  gG.computeVertexNormals();
  const gnd=new THREE.Mesh(gG,new THREE.MeshStandardMaterial({map:mkGroundTex(),roughness:.95,metalness:0,envMapIntensity:.05}));
  gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;sc.add(gnd);

  // Worn paths
  const pathMat=new THREE.MeshStandardMaterial({color:0x6a5a45,roughness:.98,metalness:0});
  for(let p=0;p<6;p++){
    const pm=new THREE.Mesh(new THREE.PlaneGeometry(2.5+R()*.5,15+R()*10),pathMat);
    pm.rotation.x=-Math.PI/2;pm.position.set(-50+R()*100,.085,-60+p*20+R()*8);pm.receiveShadow=true;sc.add(pm);
  }

  // ‚ïê‚ïê‚ïê PHOTOREALISTIC MATERIALS ‚ïê‚ïê‚ïê
  const pTex=mkPanelTex(isBi,isFS);
  const M={
    pnl:isFS
      ? new THREE.MeshStandardMaterial({map:pTex,roughness:.06,metalness:.15,envMapIntensity:.4,emissive:0x050508,emissiveIntensity:.02})
      : new THREE.MeshStandardMaterial({map:pTex,roughness:isBi?.04:.11,metalness:isBi?.75:.22,envMapIntensity:isBi?1.3:.35,emissive:isBi?0x0a0a16:0x000000,emissiveIntensity:.018}),
    frame:new THREE.MeshStandardMaterial({color:0xBEC2C6,roughness:.16,metalness:.94,envMapIntensity:.88}),
    steel:new THREE.MeshStandardMaterial({color:0x8A8A92,roughness:.38,metalness:.90,envMapIntensity:.65}),
    galv:new THREE.MeshStandardMaterial({color:0xA8AEB2,roughness:.26,metalness:.84,envMapIntensity:.78}),
    dc:new THREE.MeshStandardMaterial({color:0xA81C1C,roughness:.64,metalness:.07}),
    ac:new THREE.MeshStandardMaterial({color:0xCA6814,roughness:.60,metalness:.10}),
    inv:new THREE.MeshStandardMaterial({color:0x354050,roughness:.28,metalness:.52}),
    invD:new THREE.MeshStandardMaterial({color:0x3D4858,roughness:.32,metalness:.42}),
    conc:new THREE.MeshStandardMaterial({color:0x9C9C96,roughness:.94,metalness:0}),
    tx:new THREE.MeshStandardMaterial({color:0x4A7248,roughness:.45,metalness:.40}),
    txFin:new THREE.MeshStandardMaterial({color:0x3E6640,roughness:.40,metalness:.48}),
    fence:new THREE.MeshStandardMaterial({color:0x9A9A9A,roughness:.36,metalness:.80,transparent:true,opacity:.36,side:THREE.DoubleSide}),
    fP:new THREE.MeshStandardMaterial({color:0x888888,roughness:.33,metalness:.87}),
    comb:new THREE.MeshStandardMaterial({color:0x5C5C5C,roughness:.32,metalness:.72}),
    warn:new THREE.MeshStandardMaterial({color:0xE8C800,roughness:.35,metalness:.05}),
    led:new THREE.MeshStandardMaterial({color:0x22CC44,roughness:.1,metalness:.15,emissive:0x22AA33,emissiveIntensity:.4}),
    ledAmber:new THREE.MeshStandardMaterial({color:0xDDA030,roughness:.1,metalness:.15,emissive:0xBB8822,emissiveIntensity:.35}),
    bush:new THREE.MeshStandardMaterial({color:0x4D6F34,roughness:.96,metalness:0}),
    bark:new THREE.MeshStandardMaterial({color:0x5E3F24,roughness:.99,metalness:0}),
    canopy:new THREE.MeshStandardMaterial({color:0x3F702C,roughness:.89,metalness:0}),
    white:new THREE.MeshStandardMaterial({color:0xF7F7F7,roughness:.32,metalness:.06}),
    bldg:new THREE.MeshStandardMaterial({color:0xC7BFB2,roughness:.87,metalness:.018}),
    roof:new THREE.MeshStandardMaterial({color:0x6C6C6C,roughness:.33,metalness:.75}),
    ceramic:new THREE.MeshStandardMaterial({color:0xE7DCCE,roughness:.26,metalness:.06}),
  };

  const ROWS=16,RS=8.5,TILT=22*Math.PI/180;
  // First Solar S6+: larger panels (~2.0m x 1.2m), frameless
  // Bifacial 600W: standard (~2.28m x 1.13m), framed
  const PW=isFS?1.24:1.13, PH=isFS?2.0:2.28, PD=isFS?.028:.035, GAP=.04;
  const PPR=isFS?90:(isBi?110:95);
  const RL=PPR*(PW+GAP),X0=-RL/2,Z0=-(ROWS*RS)/2,HUB=3.4;
  const gvT=mkGravelTex();
  function gpad(cx,cz,w,d){const m=new THREE.Mesh(new THREE.PlaneGeometry(w,d),new THREE.MeshStandardMaterial({map:gvT.clone(),roughness:.82,metalness:.05}));m.material.map.repeat.set(w/8,d/8);m.material.map.wrapS=m.material.map.wrapT=THREE.RepeatWrapping;m.rotation.x=-Math.PI/2;m.position.set(cx,.09,cz);m.receiveShadow=true;sc.add(m)}

  // ‚ïê‚ïê‚ïê LABEL SIGN UTILITY ‚ïê‚ïê‚ïê
  const signs=[]; // collect for billboard rotation
  function addSign(text,x,y,z,opts){
    opts=opts||{};
    const fontSize=opts.fontSize||28;
    const maxW=opts.maxWidth||320;
    const c=document.createElement('canvas');c.width=maxW;c.height=fontSize+12;
    const ctx=c.getContext('2d');
    ctx.fillStyle='rgba(10,12,18,0.82)';
    const r=4;ctx.beginPath();ctx.moveTo(r,0);ctx.lineTo(c.width-r,0);ctx.quadraticCurveTo(c.width,0,c.width,r);
    ctx.lineTo(c.width,c.height-r);ctx.quadraticCurveTo(c.width,c.height,c.width-r,c.height);
    ctx.lineTo(r,c.height);ctx.quadraticCurveTo(0,c.height,0,c.height-r);
    ctx.lineTo(0,r);ctx.quadraticCurveTo(0,0,r,0);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1;ctx.stroke();
    ctx.font='bold '+fontSize+'px "DM Sans",Arial,sans-serif';
    ctx.fillStyle=opts.color||'rgba(255,255,255,0.92)';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(text,c.width/2,c.height/2+1);
    const tex=new THREE.CanvasTexture(c);tex.minFilter=THREE.LinearFilter;
    const aspect=c.width/c.height;
    const h=opts.scale||1.2;const w=h*aspect;
    const mat=new THREE.MeshBasicMaterial({map:tex,transparent:true,depthTest:false,side:THREE.DoubleSide});
    const sign=new THREE.Mesh(new THREE.PlaneGeometry(w,h),mat);
    sign.position.set(x,y,z);
    sign.renderOrder=999;
    sc.add(sign);
    signs.push(sign);
    // Thin post
    if(!opts.noPost){
      const postH=y-.1;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,postH,4),new THREE.MeshStandardMaterial({color:0x888888,roughness:.5,metalness:.6})).translateX(x).translateY(y-postH/2).translateZ(z));
    }
    return sign;
  }
  // Small inline cable label (no post, tiny)
  function addCableTag(text,x,y,z){
    addSign(text,x,y+.6,z,{scale:.6,fontSize:20,maxWidth:240,noPost:true});
  }

  // ‚ïê‚ïê‚ïê PANELS (InstancedMesh) ‚ïê‚ïê‚ïê
  const totP=ROWS*PPR;
  const pGeo=new THREE.BoxGeometry(PW,PH,PD);
  const panels=new THREE.InstancedMesh(pGeo,M.pnl,totP);
  panels.castShadow=true;panels.receiveShadow=true;
  const dm=new THREE.Object3D();let idx=0;
  for(let r=0;r<ROWS;r++){const rz=Z0+r*RS;for(let c=0;c<PPR;c++){
    dm.position.set(X0+c*(PW+GAP)+PW/2,HUB+Math.sin(TILT)*PH*.5,rz);
    dm.rotation.set(-TILT,0,0);dm.updateMatrix();panels.setMatrixAt(idx++,dm.matrix);
  }}
  panels.instanceMatrix.needsUpdate=true;sc.add(panels);

  // Mid-clamps (sparse for perf) ‚Äî different for frameless FS
  for(let r=0;r<ROWS;r+=4){const rz=Z0+r*RS;for(let c=5;c<PPR;c+=5){
    const px=X0+c*(PW+GAP)+PW/2;const py=HUB+Math.sin(TILT)*PH*.5;
    if(isFS){
      // Frameless: rubber-padded clamp (wider, softer look)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.05,.06,.025),new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.75,metalness:.15})).translateX(px-PW/2-.005).translateY(py).translateZ(rz));
    }else{
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.035,.08,.02),M.frame).translateX(px-PW/2-.005).translateY(py).translateZ(rz));
    }
  }}

  // ‚ïê‚ïê‚ïê TRACKER RACKING ‚ïê‚ïê‚ïê
  for(let r=0;r<ROWS;r++){
    const rz=Z0+r*RS;
    // Torque tube
    const tt=new THREE.Mesh(new THREE.CylinderGeometry(.058,.058,RL+1.5,8),M.galv);
    tt.rotation.z=Math.PI/2;tt.position.set(0,HUB,rz);tt.castShadow=true;sc.add(tt);
    // Piles
    const pSp=4*(PW+GAP),nP=Math.floor(RL/pSp)+1;
    for(let p=0;p<nP;p++){
      const px=X0+p*pSp;
      // I-beam pile
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,4.4,.065),M.steel).translateX(px).translateY(HUB/2-.15).translateZ(rz));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.045,4.15,.16),M.steel).translateX(px-.057).translateY(HUB/2-.15).translateZ(rz));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.045,4.15,.16),M.steel).translateX(px+.057).translateY(HUB/2-.15).translateZ(rz));
      // Bearing
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.24,.08,.24),M.steel).translateX(px).translateY(HUB+.04).translateZ(rz));
      // Bolts (4 per bearing)
      for(let b=0;b<4;b++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,.012,6),M.galv).translateX(px+((b%2)-.5)*.15).translateY(HUB+.085).translateZ(rz+((Math.floor(b/2))-.5)*.15));
      }
    }
    // Motor
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.65,.48,.38),M.invD).translateX(0).translateY(HUB-.28).translateZ(rz));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.75,.06,.45),M.galv).translateX(0).translateY(HUB-.52).translateZ(rz));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.25,8),M.steel).translateX(0).translateY(HUB-.55).translateZ(rz).rotateX(Math.PI/2));
    sc.add(new THREE.Mesh(new THREE.SphereGeometry(.032,8,8),M.led).translateX(-.22).translateY(HUB-.12).translateZ(rz-.19));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.004,.004,.12,4),M.steel).translateX(.25).translateY(HUB-.05).translateZ(rz-.19));
    // Mounting rails
    const railGeo=new THREE.CylinderGeometry(.022,.022,RL+.6,4);
    sc.add(new THREE.Mesh(railGeo,M.frame).translateX(0).translateY(HUB+Math.sin(TILT)*PH*.87).translateZ(rz-Math.cos(TILT)*.42).rotateZ(Math.PI/2));
    sc.add(new THREE.Mesh(railGeo.clone(),M.frame).translateX(0).translateY(HUB-Math.sin(TILT)*PH*.08).translateZ(rz+Math.cos(TILT)*.42).rotateZ(Math.PI/2));
    // Rail clamps
    for(let cl=0;cl<Math.floor(PPR/4);cl++){
      const clX=X0+cl*4*(PW+GAP)+(PW+GAP)*2;
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,.08,.08),M.galv).translateX(clX).translateY(HUB).translateZ(rz));
    }
  }

  // ‚ïê‚ïê‚ïê LABEL: PANELS ‚ïê‚ïê‚ïê
  const panelLabel=isFS?'First Solar 525W CdTe':'Bifacial 600W';
  addSign(panelLabel+' Panels',0,HUB+3,0,{scale:1.8});
  addSign('Single-Axis Trackers',X0+RL*.4,HUB+1.5,Z0+ROWS*RS/2,{scale:.9,maxWidth:300});
  waypoints.push({name:'Overview',color:'#ffffff',target:{x:40,y:2,z:0},cam:{x:-80,y:60,z:100},overview:true});
  waypoints.push({name:panelLabel+' Panels',color:'#3858A0',target:{x:0,y:HUB,z:Z0+ROWS*RS/2},cam:{x:-20,y:12,z:Z0+ROWS*RS/2+30}});

  // ‚ïê‚ïê‚ïê DC COLLECTION ‚ïê‚ïê‚ïê
  const CE=RL/2+8,DIX=X0-12,CIX=RL/2+35;

  // ‚ïê‚ïê‚ïê HIGH-VISIBILITY CABLE & CONDUIT MATERIALS ‚ïê‚ïê‚ïê
  // A: DC String wires ‚Äî USE-2 PV wire (bright red/black)
  const wireRed=new THREE.MeshStandardMaterial({color:0xDD2020,roughness:.65,metalness:.08});
  const wireBlack=new THREE.MeshStandardMaterial({color:0x181818,roughness:.75,metalness:.05});
  // B: DC Collection ‚Äî Bright orange PVC conduit (NEC standard for underground electric)
  const cableB=new THREE.MeshStandardMaterial({color:0xEE6600,roughness:.55,metalness:.05});
  // C: DC Feeder ‚Äî Blue HDPE conduit (high-visibility direct buried)
  const cableC=new THREE.MeshStandardMaterial({color:0x1560CC,roughness:.52,metalness:.08});
  // D: AC cable ‚Äî Bright chrome EMT steel conduit
  const cableD=new THREE.MeshStandardMaterial({color:0xCCD0D8,roughness:.15,metalness:.88});
  // E: MV/HV cable ‚Äî Yellow MV-rated jacket (high-voltage warning color)
  const cableE=new THREE.MeshStandardMaterial({color:0xDDAA00,roughness:.48,metalness:.12});
  // Neutral materials
  const wireGreen=new THREE.MeshStandardMaterial({color:0x1a6a22,roughness:.78,metalness:.04});
  const conduitGray=new THREE.MeshStandardMaterial({color:0x606060,roughness:.4,metalness:.6});
  const mc4Mat=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.55,metalness:.25});

  const stringLen=isFS?6:28;
  const nStringsPerRow=Math.floor(PPR/stringLen);

  if(dc==='string-homeruns'){
    // Individual string homeruns ‚Äî each string runs its own conduit
    for(let r=0;r<ROWS;r++){const rz=Z0+r*RS;
      for(let s=0;s<nStringsPerRow;s+=3){
        const sx=X0+s*(RL/nStringsPerRow)+RL/(nStringsPerRow*2);
        // Junction box on torque tube
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.30,.18,.14),new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.45,metalness:.5})).translateX(sx).translateY(HUB-.55).translateZ(rz+.22));
        // Drop conduit
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.025,.025,HUB-.7,6),conduitGray).translateX(sx).translateY((HUB-.7)/2+.05).translateZ(rz+.28));
        // Homerun conduit to inverter ‚Äî CYAN (DC Collection)
        if(inv==='distributed'){const hrLen=sx-DIX;sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.07,.07,hrLen,6),cableB).translateX(sx-hrLen/2).translateY(.04).translateZ(rz+.35).rotateZ(Math.PI/2))}
        else{const hrLen=CE-sx+8;sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.07,.07,hrLen,6),cableB).translateX(sx+hrLen/2).translateY(.04).translateZ(rz+.35).rotateZ(Math.PI/2))}
      }
      if(inv==='distributed'&&r%4===0){const tl=X0-DIX+15;sc.add(new THREE.Mesh(new THREE.BoxGeometry(tl,.005,.15),M.warn).translateX(DIX+tl/2-5).translateY(.035).translateZ(rz+.35))}
    }
    // LABEL: String Homeruns
    const hrLabelX=inv==='distributed'?(X0+DIX)/2:CE;
    // LABEL: String Homeruns ‚Äî centered on array
    addSign('String Homeruns',hrLabelX,2.5,0,{scale:1.2});
    // Cable tags
    addCableTag('USE-2 PV Wire',X0+RL*.3,HUB-.3,0);
    addCableTag('PVC Conduit (Sch 40)',inv==='distributed'?(X0+DIX)/2:(X0+CE)/2+10,.04,8);
    waypoints.push({name:'String Homeruns',color:'#EE6600',target:{x:hrLabelX,y:1,z:0},cam:{x:hrLabelX-15,y:8,z:22}});
  }else if(dc==='harnesses'){
    // DC Harnesses ‚Äî Y-connectors combining strings (matches image 2: red/black wires with MC4 Y-splits)
    const cbX=CE+8; // combiner box X position (used if combiners present)
    for(let r=0;r<ROWS;r++){const rz=Z0+r*RS;
      // Main harness trunk cables running along torque tube (red +, black -)
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,RL*.94,6),wireRed).translateX(0).translateY(HUB-.40).translateZ(rz+.24).rotateZ(Math.PI/2));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,RL*.94,6),wireBlack).translateX(0).translateY(HUB-.48).translateZ(rz+.24).rotateZ(Math.PI/2));
      // Y-connector tap points (matching image 2: MC4 Y-split connectors)
      const nY=Math.floor(PPR/(isFS?8:16));
      for(let y=0;y<nY;y++){
        const yx=X0+RL*.05+y*(RL*.9/nY);
        // MC4 connector body on positive line (cylindrical, dark)
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.022,.022,.12,8),mc4Mat).translateX(yx).translateY(HUB-.40).translateZ(rz+.24).rotateZ(Math.PI/2));
        // MC4 connector body on negative line
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.022,.022,.12,8),mc4Mat).translateX(yx).translateY(HUB-.48).translateZ(rz+.24).rotateZ(Math.PI/2));
        // Y-branch wire (red) going up to string
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.012,.012,.22,4),wireRed).translateX(yx-.05).translateY(HUB-.28).translateZ(rz+.24));
        // Y-branch wire (black) going up to string
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.012,.012,.22,4),wireBlack).translateX(yx+.05).translateY(HUB-.28).translateZ(rz+.24));
        // Y-split junction (small dark hub where wires meet)
        sc.add(new THREE.Mesh(new THREE.SphereGeometry(.018,6,6),mc4Mat).translateX(yx-.05).translateY(HUB-.40).translateZ(rz+.24));
        sc.add(new THREE.Mesh(new THREE.SphereGeometry(.018,6,6),mc4Mat).translateX(yx+.05).translateY(HUB-.48).translateZ(rz+.24));
        // Cable clip/tie on torque tube
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.03,.015,.12),M.steel).translateX(yx).translateY(HUB-.36).translateZ(rz+.24));
      }
      // Termination & routing depends on inverter type
      if(inv==='distributed'){
        // Terminate at row end closest to distributed inverter
        const termX=X0-.5;
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.32,.22,.18),new THREE.MeshStandardMaterial({color:0x222222,roughness:.45,metalness:.45})).translateX(termX).translateY(HUB-.44).translateZ(rz+.24));
        // Drop cables to ground
        const dropH=HUB-.25;
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,dropH,6),wireRed).translateX(termX-.05).translateY(HUB-.44-dropH/2).translateZ(rz+.26));
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,dropH,6),wireBlack).translateX(termX+.05).translateY(HUB-.44-dropH/2).translateZ(rz+.26));
        // Ground-level conduit from termination to distributed inverter ‚Äî CYAN
        const runLen=Math.abs(termX-DIX);
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.09,.09,runLen,6),cableB).translateX((termX+DIX)/2).translateY(.08).translateZ(rz+.3).rotateZ(Math.PI/2));
      }else{
        // Terminate at row end closest to collection area
        const termX=RL/2+1.5;
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.32,.22,.18),new THREE.MeshStandardMaterial({color:0x222222,roughness:.45,metalness:.45})).translateX(termX).translateY(HUB-.44).translateZ(rz+.24));
        // Drop cables to ground
        const dropH=HUB-.25;
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,dropH,6),wireRed).translateX(termX-.05).translateY(HUB-.44-dropH/2).translateZ(rz+.26));
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,dropH,6),wireBlack).translateX(termX+.05).translateY(HUB-.44-dropH/2).translateZ(rz+.26));
        // Underground conduit from row end all the way to combiner box column ‚Äî CYAN
        const runLen=cbX-termX;
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.09,.09,runLen,6),cableB).translateX(termX+runLen/2).translateY(.08).translateZ(rz+.3).rotateZ(Math.PI/2));
      }
    }
    // For non-distributed: N-S collection riser at combiner box column ‚Äî CYAN
    if(inv!=='distributed'){
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,ROWS*RS+12,8),cableB).translateX(cbX-1.5).translateY(.2).rotateX(Math.PI/2));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,ROWS*RS+12,8),cableB).translateX(cbX-1).translateY(.2).rotateX(Math.PI/2));
      addCableTag('PVC N-S Trunk',cbX-1.2,.2,0);
    }
    // LABEL: DC Harnesses ‚Äî over the harness wires on the torque tubes
    const hLabelX=inv==='distributed'?X0+RL*.25:X0+RL*.75;
    addSign('DC Harnesses',hLabelX,HUB+1.5,8,{scale:1.2});
    // Cable tags
    addCableTag('USE-2 PV Wire',X0+RL*.3,HUB-.3,12);
    addCableTag('PVC Conduit',inv==='distributed'?(X0+DIX)/2:(RL/2+CE)/2,.08,16);
    waypoints.push({name:'DC Harnesses',color:'#EE6600',target:{x:hLabelX,y:HUB,z:8},cam:{x:hLabelX-10,y:6,z:26}});
  }else if(dc==='trunk-bus'){
    // DC Trunk Bus (matches image 4: SUNKEAN-style AL main bus with CU string taps)
    const bLen=ROWS*RS+14,busY=2.2;
    // Main AL bus bars ‚Äî red positive, black negative (flat rectangular conductors)
    const busPosM=new THREE.MeshStandardMaterial({color:0xCC2222,roughness:.18,metalness:.82});
    const busNegM=new THREE.MeshStandardMaterial({color:0x0e0e0e,roughness:.18,metalness:.78});
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.14,bLen,.06),busPosM).translateX(-.22).translateY(busY).rotateX(Math.PI/2));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.14,bLen,.06),busNegM).translateX(.22).translateY(busY).rotateX(Math.PI/2));
    // Support structure with insulators (every 5m)
    for(let s=0;s<Math.ceil(bLen/5);s++){const sz=Z0-5+s*5;
      // Steel support posts
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,busY,.06),M.steel).translateX(-.55).translateY(busY/2).translateZ(sz));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,busY,.06),M.steel).translateX(.55).translateY(busY/2).translateZ(sz));
      // Cross arm
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.3,.06,.06),M.steel).translateY(busY+.04).translateZ(sz));
      // Ceramic insulators under bus bars
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.05,.18,8),M.ceramic).translateX(-.22).translateY(busY+.14).translateZ(sz));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.05,.18,8),M.ceramic).translateX(.22).translateY(busY+.14).translateZ(sz));
    }
    // CU string tap connections per row (matches image 4: short CU drops with inline fuse connectors)
    for(let r=0;r<ROWS;r++){const rz=Z0+r*RS;
      const nTaps=isFS?6:3;
      for(let t=0;t<nTaps;t++){
        const tx=-.22+(t%2)*.44,tz=rz-.3+Math.floor(t/2)*.2;
        // CU tap wire dropping down from bus
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.01,.01,.35,4),t%2===0?wireRed:wireBlack).translateX(tx).translateY(busY-.18).translateZ(tz));
        // Inline fuse connector (dark cylindrical body with wire ends ‚Äî matching image 4)
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.018,.018,.08,6),mc4Mat).translateX(tx).translateY(busY-.38).translateZ(tz));
      }
      // Tap junction box on bus
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.55,.28,.22),new THREE.MeshStandardMaterial({color:0x1e1e1e,roughness:.5,metalness:.45})).translateY(busY+.3).translateZ(rz));
      // Status LED
      sc.add(new THREE.Mesh(new THREE.SphereGeometry(.02,6,6),M.led).translateX(.2).translateY(busY+.46).translateZ(rz-.1));
      // Warning label
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.06,.01),M.warn).translateX(-.12).translateY(busY+.46).translateZ(rz-.12));
    }
    // LABEL: Trunk Bus
    addSign('DC Trunk Bus',0,busY+2,0,{scale:1.2});
    // Cable tags
    addCableTag('AL Bus Bars (¬±DC)',0,busY+.5,5);
    waypoints.push({name:'DC Trunk Bus',color:'#CC2222',target:{x:0,y:busY,z:0},cam:{x:-8,y:6,z:15}});
  }

  // ‚ïê‚ïê‚ïê DC COMBINATION ‚ïê‚ïê‚ïê
  const IX=CIX;
  if(comb==='combiner-boxes'){
    // Combiner boxes (matches images 3 & 5: gray/white NEMA enclosures on steel posts,
    // clear door panels, colored breakers inside, cable glands at bottom, yellow warning labels)
    const nCB=inv==='central'?14:10,cbX=CE+8;
    const cbBodyM=new THREE.MeshStandardMaterial({color:0xF2F2EE,roughness:.32,metalness:.15}); // Bright white NEMA enclosure
    const cbDoorM=new THREE.MeshStandardMaterial({color:0xC8D0D8,roughness:.12,metalness:.15,transparent:true,opacity:.75}); // Clear/frosted door
    const cbFrameM=new THREE.MeshStandardMaterial({color:0x9a9a98,roughness:.3,metalness:.65}); // Metal frame
    const breakerGreen=new THREE.MeshStandardMaterial({color:0x2A8A42,roughness:.45,metalness:.2});
    const spdOrange=new THREE.MeshStandardMaterial({color:0xE87420,roughness:.4,metalness:.12});
    const breakerGray=new THREE.MeshStandardMaterial({color:0xE0E0E0,roughness:.4,metalness:.18});
    for(let i=0;i<nCB;i++){const cbZ=Z0+4+(i/(nCB-1))*(ROWS-2)*RS;
      // Concrete footing
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.45,.12,.35),M.conc).translateX(cbX).translateY(.06).translateZ(cbZ));
      // Steel mounting post (galvanized)
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,3.4,8),M.galv).translateX(cbX-.3).translateY(1.76).translateZ(cbZ));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.05,.05,3.4,8),M.galv).translateX(cbX+.3).translateY(1.76).translateZ(cbZ));
      // Cross rail
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.65,.04,.04),M.galv).translateX(cbX).translateY(2.9).translateZ(cbZ));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.65,.04,.04),M.galv).translateX(cbX).translateY(3.5).translateZ(cbZ));
      // Main enclosure body (light gray ‚Äî matches image 3)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.85,.72,.35),cbBodyM).translateX(cbX).translateY(3.2).translateZ(cbZ));
      // Door frame rim
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.87,.74,.02),cbFrameM).translateX(cbX).translateY(3.2).translateZ(cbZ-.19));
      // Clear door panel (frosted ‚Äî you can see breakers inside)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.78,.65,.01),cbDoorM).translateX(cbX).translateY(3.22).translateZ(cbZ-.195));
      // Door handle/latch
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.04,.08,.02),cbFrameM).translateX(cbX+.36).translateY(3.2).translateZ(cbZ-.21));
      // Inside: DC breakers (green handles ‚Äî matches image 3)
      for(let br=0;br<4;br++){
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.1,.18,.08),breakerGray).translateX(cbX-.28+br*.15).translateY(3.3).translateZ(cbZ-.1));
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.04,.06,.02),breakerGreen).translateX(cbX-.28+br*.15).translateY(3.35).translateZ(cbZ-.15));
      }
      // SPD (orange ‚Äî matches image 3)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.2,.08),spdOrange).translateX(cbX+.12).translateY(3.3).translateZ(cbZ-.1));
      // AC breakers (white/smaller)
      for(let ab=0;ab<2;ab++){
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,.15,.06),breakerGray).translateX(cbX+.28+ab*.1).translateY(3.28).translateZ(cbZ-.1));
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.03,.05,.02),breakerGreen).translateX(cbX+.28+ab*.1).translateY(3.32).translateZ(cbZ-.15));
      }
      // Cable glands at bottom (matching image 3: 5 glands with colored wires)
      const glandM=new THREE.MeshStandardMaterial({color:0xc0c0c0,roughness:.25,metalness:.6});
      for(let gl=0;gl<5;gl++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.022,.028,.06,8),glandM).translateX(cbX-.24+gl*.12).translateY(2.81).translateZ(cbZ));
        // Wire coming out of gland (red, black, green alternating like image 3)
        const wM=gl<2?wireRed:gl<4?wireBlack:wireGreen;
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.012,.012,.4,4),wM).translateX(cbX-.24+gl*.12).translateY(2.58).translateZ(cbZ));
      }
      // Yellow warning label
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.28,.08,.005),M.warn).translateX(cbX-.15).translateY(3.55).translateZ(cbZ-.2));
      // High voltage sticker (small)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.12,.005),new THREE.MeshStandardMaterial({color:0xff6600,roughness:.5,metalness:.1})).translateX(cbX+.25).translateY(3.55).translateZ(cbZ-.2));
      // Status LED
      sc.add(new THREE.Mesh(new THREE.SphereGeometry(.012,6,6),new THREE.MeshBasicMaterial({color:0x22dd44})).translateX(cbX-.35).translateY(3.55).translateZ(cbZ-.2));
      // === OUTPUT: DC feeder from combiner box to inverter area === MAGENTA
      const cbOutLen=IX-cbX-2;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,cbOutLen,6),cableC).translateX(cbX+1+cbOutLen/2).translateY(.15).translateZ(cbZ).rotateZ(Math.PI/2));
    }
    // N-S collection trunk at inverter side of combiner boxes ‚Äî blue HDPE
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.16,.16,ROWS*RS+8,8),cableC).translateX(IX-2).translateY(.15).rotateX(Math.PI/2));
    const cbZmid=Z0+4+((ROWS-2)*RS)/2;
    // N-S INPUT trunk at combiner input side ‚Äî orange PVC (connects homeruns to combiner boxes)
    if(dc==='string-homeruns'){
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,ROWS*RS+12,8),cableB).translateX(cbX-1).translateY(.12).rotateX(Math.PI/2));
      addCableTag('PVC Trunk (DC Input)',cbX-1,.12,cbZmid-10);
    }
    // LABEL: Combiner Boxes ‚Äî centered on the column
    addSign('Combiner Boxes',cbX,5,cbZmid,{scale:1.1});
    addCableTag('HDPE Conduit (DC Feeder)',(cbX+IX)/2,.15,cbZmid+5);
    addCableTag('HDPE N-S Trunk',IX-2,.15,cbZmid-8);
    waypoints.push({name:'Combiner Boxes',color:'#F2F2EE',target:{x:cbX,y:3,z:cbZmid},cam:{x:cbX-10,y:7,z:cbZmid+18}});
  }else if(comb==='lbds'){
    // LBDs ‚Äî Large DC Boxes (industrial-scale aggregation enclosures, matches image 5 field boxes but larger)
    const nLBD=6,lbdX=CE+12;
    const lbdBodyM=new THREE.MeshStandardMaterial({color:0x90989E,roughness:.32,metalness:.45});
    const lbdDoorM=new THREE.MeshStandardMaterial({color:0xB8BCC0,roughness:.15,metalness:.2,transparent:true,opacity:.7});
    for(let i=0;i<nLBD;i++){const lbdZ=Z0+4+(i/(nLBD-1))*(ROWS-2)*RS;
      gpad(lbdX,lbdZ,5,4);
      // LBD steel enclosure (larger than combiner box)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.8,2.2,1.2),lbdBodyM).translateX(lbdX).translateY(1.2).translateZ(lbdZ));
      // Top ventilation louvers
      for(let v=0;v<4;v++)sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.6,.03,.01),M.steel).translateX(lbdX).translateY(2.0+v*.08).translateZ(lbdZ-.62));
      // Front door with clear panel (like image 5 field boxes)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,1.6,.01),lbdDoorM).translateX(lbdX).translateY(1.1).translateZ(lbdZ-.61));
      // Door handles
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,.12,.03),M.steel).translateX(lbdX+.65).translateY(1.2).translateZ(lbdZ-.64));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,.12,.03),M.steel).translateX(lbdX-.65).translateY(1.2).translateZ(lbdZ-.64));
      // Warning stripes (yellow/black)
      for(let w=0;w<3;w++)sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.82,.05,.01),M.warn).translateX(lbdX).translateY(.25+w*.7).translateZ(lbdZ-.615));
      // Emergency disconnect handle (red)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,.45,.1),new THREE.MeshStandardMaterial({color:0xDD0000,roughness:.35,metalness:.4})).translateX(lbdX+.8).translateY(1.6).translateZ(lbdZ-.58));
      // Cable glands (bottom, larger gauge)
      for(let gl=0;gl<6;gl++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.03,.04,.08,8),new THREE.MeshStandardMaterial({color:0xc0c0c0,roughness:.25,metalness:.6})).translateX(lbdX-.5+gl*.2).translateY(.06).translateZ(lbdZ));
      }
      // DC feeder output to inverter ‚Äî MAGENTA
      const lbdOutLen=IX-lbdX-2;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.09,.09,lbdOutLen,6),cableC).translateX(lbdX+1+lbdOutLen/2).translateY(.18).translateZ(lbdZ).rotateZ(Math.PI/2));
      // === INPUT: Trunk bus feeder cable from bus (X‚âà0) to this LBD === CYAN
      const lbdInLen=lbdX-.5;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,lbdInLen,6),cableB).translateX(.5+lbdInLen/2).translateY(.12).translateZ(lbdZ-.3).rotateZ(Math.PI/2));
      // Yellow high-voltage label
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.4,.25,.005),new THREE.MeshStandardMaterial({color:0xff6600,roughness:.5,metalness:.1})).translateX(lbdX-.4).translateY(1.7).translateZ(lbdZ-.62));
      // Yellow warning triangle
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.18,.18,.005),M.warn).translateX(lbdX+.35).translateY(1.7).translateZ(lbdZ-.62));
    }
    // N-S collection trunk at inverter side of LBDs ‚Äî blue HDPE
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.16,.16,ROWS*RS+8,8),cableC).translateX(IX-2).translateY(.18).rotateX(Math.PI/2));
    // LABEL: LBDs ‚Äî centered on the column
    const lbdZmid=Z0+4+((ROWS-2)*RS)/2;
    addSign('Load Break Disconnects',lbdX,4,lbdZmid,{scale:1.1,maxWidth:380});
    addCableTag('HDPE Conduit (DC Feeder)',(lbdX+IX)/2,.18,lbdZmid+5);
    addCableTag('PVC Conduit (Input)',lbdX/2,.12,lbdZmid-8);
    addCableTag('HDPE N-S Trunk',IX-2,.18,lbdZmid-15);
    waypoints.push({name:'Load Break Disconnects',color:'#90989E',target:{x:lbdX,y:2,z:lbdZmid},cam:{x:lbdX-10,y:6,z:lbdZmid+18}});
  }

  // ‚ïê‚ïê‚ïê INVERTERS ‚ïê‚ïê‚ïê
  // Materials matching real equipment (images 6 & 7)
  const invGreenDark=new THREE.MeshStandardMaterial({color:0x1A7A68,roughness:.30,metalness:.42}); // Vivid teal body
  const invGreenLight=new THREE.MeshStandardMaterial({color:0x30A888,roughness:.28,metalness:.38}); // Bright green doors
  const invSidePanel=new THREE.MeshStandardMaterial({color:0xDDD8CC,roughness:.40,metalness:.25}); // Light beige side panels
  const hazardTriM=new THREE.MeshStandardMaterial({color:0xE8C000,roughness:.3,metalness:.05}); // Yellow hazard triangles
  const ventM=new THREE.MeshStandardMaterial({color:0x1E3E3C,roughness:.3,metalness:.55}); // Vent louver slats

  if(inv==='distributed'){
    // Distributed string inverters ‚Äî small units mounted on stands near tracker rows
    for(let r=0;r<ROWS;r+=2){const rz=Z0+r*RS+RS/2,ix=DIX;
      gpad(ix,rz,5,4);
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(5.2,.15,4.2),new THREE.MeshStandardMaterial({color:0x888880,roughness:.85,metalness:.05})).translateX(ix).translateY(.075).translateZ(rz));
      // Mounting stand (galvanized steel posts + cross rails)
      const standMat=new THREE.MeshStandardMaterial({color:0x8a9090,roughness:.35,metalness:.75});
      for(let p=0;p<4;p++){const px=ix+((p%2)-.5)*1.4,pz=rz+((Math.floor(p/2))-.5)*.6;
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,1.6,.06),standMat).translateX(px).translateY(.85).translateZ(pz));
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.15,.02,.15),standMat).translateX(px).translateY(.12).translateZ(pz));
      }
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,.05,.05),standMat).translateX(ix).translateY(1.62).translateZ(rz-.28));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,.05,.05),standMat).translateX(ix).translateY(1.62).translateZ(rz+.28));
      // Inverter body (dark housing with heatsink fins)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.3,1.0,.55),M.inv).translateX(ix).translateY(1.15).translateZ(rz));
      for(let f=0;f<10;f++){
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.018,.85,.52),M.invD).translateX(ix+.58+f*.01).translateY(1.15).translateZ(rz));
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.018,.85,.52),M.invD).translateX(ix-.58-f*.01).translateY(1.15).translateZ(rz));
      }
      // LCD display
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.42,.22,.005),new THREE.MeshStandardMaterial({color:0x0a2848,roughness:.05,metalness:.1,emissive:0x051525,emissiveIntensity:.3})).translateX(ix-.25).translateY(1.28).translateZ(rz-.3));
      // Status LEDs
      const ledColors=[0x22dd44,0x22dd44,0x22dd44,0x2288ff,0xffaa00];
      for(let l=0;l<5;l++)sc.add(new THREE.Mesh(new THREE.SphereGeometry(.015,6,6),new THREE.MeshBasicMaterial({color:ledColors[l]})).translateX(ix-.38+l*.09).translateY(1.52).translateZ(rz-.295));
      // Emergency stop button (red)
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,.025,12),new THREE.MeshStandardMaterial({color:0xcc0000,roughness:.35,metalness:.4})).translateX(ix-.48).translateY(1.05).translateZ(rz-.31).rotateX(Math.PI/2));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.03,.002),M.warn).translateX(ix-.48).translateY(.93).translateZ(rz-.296));
      // DC input conduits ‚Äî orange PVC (from collection)
      for(let d=0;d<Math.min(nStringsPerRow,6);d++){const condX=ix-.4+d*.15;
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,.45,6),cableB).translateX(condX).translateY(.32).translateZ(rz+.15));
      }
      // AC output conduit ‚Äî silver EMT
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,3,8),cableD).translateX(ix+2.5).translateY(.25).translateZ(rz).rotateZ(Math.PI/2));
      // Communication module
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.18,.08),new THREE.MeshStandardMaterial({color:0x2255aa,roughness:.4,metalness:.35})).translateX(ix+.2).translateY(1.05).translateZ(rz+.25));
    }
    // AC collection ‚Äî silver EMT conduit
    for(let r=0;r<ROWS;r+=2){const rz=Z0+r*RS+RS/2;
      const acRunLen=IX-DIX-16;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,acRunLen,6),cableD).translateX(DIX+3+acRunLen/2).translateY(.08).translateZ(rz).rotateZ(Math.PI/2));
    }
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.2,.2,ROWS*RS+6,8),cableD).translateX(IX-18).translateY(.15).rotateX(Math.PI/2));
    addCableTag('EMT N-S AC Trunk',IX-18,.15,0);
    // AC recombiner panel
    gpad(IX-12,0,12,16);
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(4,2.8,1.6),new THREE.MeshStandardMaterial({color:0x454545,roughness:.4,metalness:.55})).translateX(IX-12).translateY(1.5));
    for(let l=0;l<4;l++)sc.add(new THREE.Mesh(new THREE.SphereGeometry(.025,6,6),M.led).translateX(IX-13.5+l*.35).translateY(2.65).translateZ(-.84));
    // Cable from N-S trunk through recombiner to transformer ‚Äî silver EMT
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,23,8),cableD).translateX(IX-6.5).translateY(.2).rotateZ(Math.PI/2));
    // Step-up transformer
    gpad(IX+5,0,14,12);
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(10,.4,8),M.conc).translateX(IX+5).translateY(.2));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(5,3.5,3.5),M.tx).translateX(IX+5).translateY(2.0));
    for(let side=-1;side<=1;side+=2)for(let f=0;f<8;f++)sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,2.8,.08),M.txFin).translateX(IX+7.8+f*.18).translateY(1.8).translateZ(side*2));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.35,.35,3,10),M.tx).translateX(IX+5).translateY(4.5).rotateZ(Math.PI/2));
    for(let b=0;b<3;b++){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.18,2,10),M.ceramic).translateX(IX+4+b).translateY(4.8).translateZ(-2.2));
      for(let sh=0;sh<4;sh++)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.22,.18,.08,12),M.ceramic).translateX(IX+4+b).translateY(4.0+sh*.45).translateZ(-2.2));
    }
    // MV cable from transformer to substation trench ‚Äî yellow
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.22,.22,30,8),cableE).translateX(IX+22).translateY(.25).rotateZ(Math.PI/2));
    // LABELS
    addSign('String Inverters',DIX,3,0,{scale:1.1});
    addSign('AC Recombiner',IX-12,4.5,0,{scale:1.0});
    addSign('Step-Up Transformer',IX+5,5.5,0,{scale:1.1});
    // Cable tags
    addCableTag('EMT Conduit (AC)',(DIX+IX-18)/2,.08,10);
    addCableTag('MV XLPE 34.5kV',IX+22,.25,3);
    waypoints.push({name:'String Inverters',color:'#1A7A68',target:{x:DIX,y:1.5,z:0},cam:{x:DIX-10,y:5,z:18}});
    waypoints.push({name:'AC Recombiner',color:'#CCD0D8',target:{x:IX-12,y:2,z:0},cam:{x:IX-18,y:6,z:12}});
    waypoints.push({name:'Step-Up Transformer',color:'#4A7248',target:{x:IX+5,y:2,z:0},cam:{x:IX+5,y:6,z:15}});

  }else if(inv==='centralized-cluster'){
    // Centralized cluster ‚Äî HBMK-style inverter skids on pad (matches image 7 diagram layout)
    gpad(IX,0,40,32);
    for(let row=0;row<2;row++)for(let col=0;col<3;col++){const skidX=IX-12+col*12,skidZ=-8+row*16;
      // Skid base / steel frame
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(7,.12,4),new THREE.MeshStandardMaterial({color:0x6a6a68,roughness:.7,metalness:.5})).translateX(skidX).translateY(.06).translateZ(skidZ));
      // Main inverter body (dark teal green like image 6)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(6.5,3.0,3.5),invGreenDark).translateX(skidX).translateY(1.62).translateZ(skidZ));
      // Side panel (beige/light gray ‚Äî image 6 left side panel)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,2.6,3.4),invSidePanel).translateX(skidX-3.28).translateY(1.62).translateZ(skidZ));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.06,2.6,3.4),invSidePanel).translateX(skidX+3.28).translateY(1.62).translateZ(skidZ));
      // Front double doors (slightly lighter green)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.8,2.5,.06),invGreenLight).translateX(skidX-.8).translateY(1.55).translateZ(skidZ-1.78));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.8,2.5,.06),invGreenLight).translateX(skidX+.8).translateY(1.55).translateZ(skidZ-1.78));
      // Door gap line
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.015,2.4,.002),new THREE.MeshStandardMaterial({color:0x0a0a0a})).translateX(skidX).translateY(1.55).translateZ(skidZ-1.82));
      // Yellow hazard triangles on doors (matches image 6)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.35,.35,.005),hazardTriM).translateX(skidX-.8).translateY(2.0).translateZ(skidZ-1.82));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.35,.35,.005),hazardTriM).translateX(skidX+.8).translateY(2.0).translateZ(skidZ-1.82));
      // Ventilation louvers on top (matches image 6 upper grilles)
      for(let v=0;v<6;v++){
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(4,.04,.01),ventM).translateX(skidX).translateY(2.85+v*.08).translateZ(skidZ-1.77));
      }
      // Top louver grille (side)
      for(let v=0;v<4;v++){
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.01,.04,2.5),ventM).translateX(skidX+3.26).translateY(2.85+v*.08).translateZ(skidZ));
        sc.add(new THREE.Mesh(new THREE.BoxGeometry(.01,.04,2.5),ventM).translateX(skidX-3.26).translateY(2.85+v*.08).translateZ(skidZ));
      }
      // Door handles (cylindrical)
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,.2,6),M.steel).translateX(skidX-.15).translateY(1.55).translateZ(skidZ-1.85));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,.2,6),M.steel).translateX(skidX+.15).translateY(1.55).translateZ(skidZ-1.85));
      // LCD panel
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.7,.5,.02),new THREE.MeshStandardMaterial({color:0x0a2040,roughness:.05,metalness:.1})).translateX(skidX-2.0).translateY(2.0).translateZ(skidZ-1.8));
      // Status LED
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,.08,8),M.led).translateX(skidX+2.8).translateY(3.15).translateZ(skidZ-1.6));
    }
    // MV Transformer (matches image 7 ‚Äî compact MV skid)
    gpad(IX+16,0,14,10);
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(10,.3,7),M.conc).translateX(IX+16).translateY(.15));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(5,3.5,3.2),M.tx).translateX(IX+16).translateY(2.0));
    // Cooling fins (radiator)
    for(let f=0;f<10;f++)sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,2.8,3.22),M.txFin).translateX(IX+18.5+f*.2).translateY(2.0));
    // HV bushings
    for(let b=0;b<3;b++)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.15,1.6,8),M.ceramic).translateX(IX+15+b).translateY(4.5));
    // === DC INPUT: cables from combiner/LBD area into inverter cluster === blue HDPE
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,20,8),cableC).translateX(IX-12).translateY(.2).rotateZ(Math.PI/2));
    // === AC: inverter cluster ‚Üí transformer (short run) === silver EMT
    for(let ac=0;ac<3;ac++)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,14,6),cableD).translateX(IX+9).translateY(.2+ac*.18).rotateZ(Math.PI/2));
    // === AC: transformer ‚Üí substation trench === yellow MV
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,28,8),cableE).translateX(IX+30).translateY(.25).rotateZ(Math.PI/2));
    // LABELS
    addSign('Inverter Cluster',IX,5,0,{scale:1.3});
    addSign('MV Transformer',IX+16,5,0,{scale:1.1});
    // Cable tags
    addCableTag('HDPE (DC Input)',IX-12,.2,-6);
    addCableTag('EMT Conduit (AC)',IX+9,.2,4);
    addCableTag('MV XLPE 34.5kV',IX+30,.25,3);
    waypoints.push({name:'Inverter Cluster',color:'#1A7A68',target:{x:IX,y:2,z:0},cam:{x:IX-20,y:10,z:25}});
    waypoints.push({name:'MV Transformer',color:'#4A7248',target:{x:IX+16,y:2,z:0},cam:{x:IX+16,y:6,z:14}});

  }else if(inv==='central'){
    // Central inverter + MV transformer skid (matches image 6: large dark green container)
    gpad(IX,0,36,26);
    // Concrete foundation
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(24,.25,14),M.conc).translateX(IX).translateY(.12));
    // Main container body (dark teal green ‚Äî image 6)
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(22,5.5,12),invGreenDark).translateX(IX).translateY(2.88));
    // Side panels (beige ‚Äî image 6 left side)
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,5.0,11.5),invSidePanel).translateX(IX-11.05).translateY(2.88));
    // Front: 3 double doors (dark green with hazard triangles ‚Äî image 6)
    for(let d=0;d<3;d++){
      const dx=IX-7+d*7;
      // Door panels
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.8,4.2,.06),invGreenLight).translateX(dx).translateY(2.2).translateZ(-6.04));
      // Door gap
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.015,4.0,.002),new THREE.MeshStandardMaterial({color:0x0a0a0a})).translateX(dx).translateY(2.2).translateZ(-6.08));
      // Yellow hazard triangles (image 6)
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.5,.5,.005),hazardTriM).translateX(dx-.6).translateY(3.0).translateZ(-6.08));
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.5,.5,.005),hazardTriM).translateX(dx+.6).translateY(3.0).translateZ(-6.08));
      // Door handles
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.25,6),M.steel).translateX(dx-.1).translateY(2.2).translateZ(-6.1));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.25,6),M.steel).translateX(dx+.1).translateY(2.2).translateZ(-6.1));
    }
    // Ventilation louvers on top front (matches image 6 upper grilles)
    for(let v=0;v<8;v++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(18,.05,.01),ventM).translateX(IX).translateY(4.8+v*.1).translateZ(-6.03));
    }
    // Side ventilation louvers
    for(let v=0;v<6;v++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.01,.05,8),ventM).translateX(IX+11.05).translateY(4.6+v*.1));
    }
    // Roof-mounted cooling units
    for(let c=0;c<6;c++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.8,1.4,2.8),new THREE.MeshStandardMaterial({color:0x3a4a48,roughness:.35,metalness:.5})).translateX(IX-8+c*3.2).translateY(6.3));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.95,.95,.12,16),new THREE.MeshStandardMaterial({color:0x4a5a58,roughness:.3,metalness:.55})).translateX(IX-8+c*3.2).translateY(7.05));
    }
    // MV Switchgear building (adjacent)
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(6,5,5),M.bldg).translateX(IX+14).translateY(2.6));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,1.8,.06),new THREE.MeshStandardMaterial({color:0x88AACC,roughness:.1,metalness:.2,transparent:true,opacity:.6})).translateX(IX+14).translateY(3.0).translateZ(-2.54));
    // === DC INPUT: cables from combiner/LBD area into central inverter === blue HDPE
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.15,20,8),cableC).translateX(IX-12).translateY(.25).rotateZ(Math.PI/2));
    // === AC: central inverter ‚Üí switchgear ‚Üí substation === yellow MV
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.22,.22,40,8),cableE).translateX(IX+34).translateY(.25).rotateZ(Math.PI/2));
    // LABELS
    addSign('Central Inverter',IX,8,0,{scale:1.4});
    addSign('MV Switchgear',IX+14,5.5,0,{scale:1.0});
    // Cable tags
    addCableTag('HDPE (DC Input)',IX-12,.25,-6);
    addCableTag('MV XLPE 34.5kV',IX+34,.25,3);
    waypoints.push({name:'Central Inverter',color:'#1A7A68',target:{x:IX,y:3,z:0},cam:{x:IX-25,y:12,z:25}});
    waypoints.push({name:'MV Switchgear',color:'#C5BDB0',target:{x:IX+14,y:3,z:0},cam:{x:IX+14,y:6,z:12}});
  }

  // ‚ïê‚ïê‚ïê SUBSTATION ‚ïê‚ïê‚ïê
  const SX=IX+55,SZ=-35;
  // Gravel yard
  const subGravelTex=mkGravelTex();subGravelTex.repeat.set(6,5);
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(52,46),new THREE.MeshStandardMaterial({map:subGravelTex,roughness:.92,metalness:0})).translateX(SX).translateY(.06).translateZ(SZ).rotateX(-Math.PI/2));
  // Chain-link fence (perimeter posts + rails)
  const fenceM=new THREE.MeshStandardMaterial({color:0x909090,roughness:.45,metalness:.7});
  const fenceWire=new THREE.MeshStandardMaterial({color:0x999999,roughness:.5,metalness:.5,transparent:true,opacity:.3});
  for(let side=0;side<4;side++){
    const isX=side<2;const sign=side%2===0?-1:1;
    const len=isX?46:52;const count=Math.floor(len/4);
    for(let p=0;p<=count;p++){
      const frac=p/count-.5;
      const fx=isX?SX+sign*26:SX+frac*52;
      const fz=isX?SZ+frac*46:SZ+sign*23;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.05,3,6),fenceM).translateX(fx).translateY(1.5).translateZ(fz));
      sc.add(new THREE.Mesh(new THREE.SphereGeometry(.06,6,6),fenceM).translateX(fx).translateY(3.05).translateZ(fz));
    }
    // Top and bottom rails
    const rx=isX?SX+sign*26:SX;const rz=isX?SZ:SZ+sign*23;
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,len,6),fenceM).translateX(rx).translateY(2.9).translateZ(rz).rotateZ(isX?0:Math.PI/2).rotateY(isX?Math.PI/2:0));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,len,6),fenceM).translateX(rx).translateY(.4).translateZ(rz).rotateZ(isX?0:Math.PI/2).rotateY(isX?Math.PI/2:0));
    // Wire mesh panels
    sc.add(new THREE.Mesh(new THREE.PlaneGeometry(len,2.5),fenceWire).translateX(rx).translateY(1.65).translateZ(rz).rotateY(isX?0:Math.PI/2));
  }

  // === MAIN POWER TRANSFORMER ===
  const txPadW=18,txPadD=14;
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(txPadW,.35,txPadD),M.conc).translateX(SX).translateY(.17).translateZ(SZ));
  // Oil containment berm (raised concrete lip)
  for(let bs=0;bs<4;bs++){
    const isXs=bs<2;const bsign=bs%2===0?-1:1;
    const bl=isXs?txPadD:txPadW;
    const bx=isXs?SX+bsign*(txPadW/2+.15):SX;
    const bz=isXs?SZ:SZ+bsign*(txPadD/2+.15);
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(isXs?.3:txPadW+.6,.5,isXs?txPadD:.3),M.conc).translateX(bx).translateY(.55).translateZ(bz));
  }
  // Transformer tank (dark olive-gray, realistic corrugated steel)
  const txW=8,txH=7,txD=5.5;
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(txW,txH,txD),M.tx).translateX(SX).translateY(txH/2+.35).translateZ(SZ));
  // Corrugation ribs on tank sides
  for(let side2=-1;side2<=1;side2+=2){
    for(let rib2=0;rib2<18;rib2++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.04,txH-.4,.06),M.txFin).translateX(SX-txW/2+.4+rib2*(txW-.8)/17).translateY(txH/2+.35).translateZ(SZ+side2*(txD/2+.03)));
    }
    // Horizontal stiffener bands
    for(let band=0;band<3;band++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(txW+.1,.12,.04),M.tx).translateX(SX).translateY(1.5+band*2.5).translateZ(SZ+side2*(txD/2+.05)));
    }
  }
  // Tank lifting lugs
  for(let lug=0;lug<4;lug++){
    const lugX=SX+((lug%2)-.5)*(txW-.8);const lugZ=SZ+((Math.floor(lug/2))-.5)*(txD-.4);
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.3,.5,.08),M.steel).translateX(lugX).translateY(txH+.1).translateZ(lugZ));
  }

  // Radiator banks (oil cooling fins ‚Äî both sides)
  const radM=new THREE.MeshStandardMaterial({color:0x505850,roughness:.42,metalness:.6});
  for(let side3=-1;side3<=1;side3+=2){
    const radZ=SZ+side3*(txD/2+1.2);
    // Radiator header pipes (top + bottom)
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,txW-1,8),radM).translateX(SX).translateY(txH-.2).translateZ(radZ).rotateZ(Math.PI/2));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,txW-1,8),radM).translateX(SX).translateY(1.2).translateZ(radZ).rotateZ(Math.PI/2));
    // Individual fin plates
    for(let fin=0;fin<22;fin++){
      const fx2=SX-txW/2+.8+fin*((txW-1.6)/21);
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.03,txH-2.2,1.8),radM).translateX(fx2).translateY(txH/2+.1).translateZ(radZ));
    }
    // Cooling fans (2 per side)
    for(let fan=0;fan<2;fan++){
      const fanX=SX-2+fan*4;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.55,.55,.15,16),M.steel).translateX(fanX).translateY(txH/2+.5).translateZ(radZ+side3*.9));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,.2,8),new THREE.MeshStandardMaterial({color:0x333333,roughness:.5,metalness:.4})).translateX(fanX).translateY(txH/2+.5).translateZ(radZ+side3*1.05));
    }
  }

  // Conservator tank (cylindrical, on top)
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.55,.55,5,12),M.tx).translateX(SX).translateY(txH+1.2).translateZ(SZ).rotateZ(Math.PI/2));
  // Conservator brackets
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,1,.08),M.steel).translateX(SX-1.5).translateY(txH+.5).translateZ(SZ));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.08,1,.08),M.steel).translateX(SX+1.5).translateY(txH+.5).translateZ(SZ));
  // Buchholz relay (small box on pipe between tank and conservator)
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.4,.3,.3),new THREE.MeshStandardMaterial({color:0x606058,roughness:.5,metalness:.4})).translateX(SX-.3).translateY(txH+.3).translateZ(SZ-.3));

  // HV Bushings (3 phase ‚Äî tall ceramic/porcelain)
  const bushM=new THREE.MeshStandardMaterial({color:0xE0D8CC,roughness:.28,metalness:.08});
  const bushCapM=new THREE.MeshStandardMaterial({color:0x8A8A8A,roughness:.3,metalness:.7});
  for(let b=0;b<3;b++){
    const bx=SX-2+b*2;const bushBase=txH+.35;
    // Porcelain body with skirts
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.14,.2,4.5,12),bushM).translateX(bx).translateY(bushBase+2.5).translateZ(SZ-txD/2-.5));
    for(let s=0;s<9;s++){
      const skirtR=.38-.015*s;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(skirtR,skirtR-.04,.1,12),bushM).translateX(bx).translateY(bushBase+.5+s*.5).translateZ(SZ-txD/2-.5));
    }
    // Metal cap + terminal
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.14,.2,8),bushCapM).translateX(bx).translateY(bushBase+4.9).translateZ(SZ-txD/2-.5));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,.4,6),bushCapM).translateX(bx).translateY(bushBase+5.2).translateZ(SZ-txD/2-.5));
  }
  // LV Bushings (shorter, opposite side)
  for(let b=0;b<3;b++){
    const bx=SX-2+b*2;const bushBase=txH+.35;
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.16,2.5,10),bushM).translateX(bx).translateY(bushBase+1.5).translateZ(SZ+txD/2+.4));
    for(let s=0;s<5;s++){
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.28-.02*s,.25-.02*s,.08,10),bushM).translateX(bx).translateY(bushBase+.3+s*.45).translateZ(SZ+txD/2+.4));
    }
  }
  // Nameplate
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.8,.5,.01),new THREE.MeshStandardMaterial({color:0xD0D0C8,roughness:.3,metalness:.4})).translateX(SX-2.5).translateY(3).translateZ(SZ-txD/2-.01));
  // Oil level gauge
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,.6,6),new THREE.MeshStandardMaterial({color:0xAA2020,roughness:.35,metalness:.5})).translateX(SX+3).translateY(5).translateZ(SZ-txD/2-.08));
  // Pressure relief valve
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.06,.3,8),M.steel).translateX(SX+3.5).translateY(txH+.5).translateZ(SZ));

  // === BUS STRUCTURES (H-frame steel) ===
  const busColors=[0xCC2222,0xDDAA00,0x2266CC]; // A/B/C phase colors
  for(let sup=0;sup<4;sup++){
    const supX=SX-12+sup*6.5;
    // Steel H-frame columns (lattice look)
    for(let col=-1;col<=1;col+=2){
      const cx=supX+col*.9;
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.12,10),M.galv).translateX(cx).translateY(5).translateZ(SZ-9).rotateX(Math.PI/2).rotateY(0));
      // Actually vertical columns
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.09,.12,12,6),M.galv).translateX(cx).translateY(6).translateZ(SZ-9));
      // Base plate
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.4,.08,.4),M.steel).translateX(cx).translateY(.08).translateZ(SZ-9));
    }
    // Cross arms
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.2,.15,.12),M.galv).translateX(supX).translateY(11.5).translateZ(SZ-9));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.2,.15,.12),M.galv).translateX(supX).translateY(10).translateZ(SZ-9));
    // Diagonal bracing
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.03,.03,4,4),M.galv).translateX(supX).translateY(8).translateZ(SZ-9).rotateZ(.35));
  }
  // 3-phase bus conductors (colored aluminum tubes)
  for(let phase=0;phase<3;phase++){
    const busY=10.8+phase*1;
    const busZ2=SZ-9-phase*.3;
    const busLen=22;
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,busLen,8),new THREE.MeshStandardMaterial({color:busColors[phase],roughness:.22,metalness:.82})).translateX(SX-1).translateY(busY).translateZ(busZ2).rotateZ(Math.PI/2));
    // Suspension insulators at each support
    for(let ins=0;ins<4;ins++){
      const insX=SX-12+ins*6.5;
      for(let disc=0;disc<4;disc++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.08,.1,10),bushM).translateX(insX).translateY(busY+.3+disc*.18).translateZ(busZ2));
      }
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.7,4),M.steel).translateX(insX).translateY(busY+.65).translateZ(busZ2));
    }
  }

  // === CONTROL HOUSE ===
  const chX=SX-16,chZ=SZ+2;
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(8.5,.25,6),M.conc).translateX(chX).translateY(.12).translateZ(chZ));
  // Walls (precast concrete / CMU block)
  const wallM=new THREE.MeshStandardMaterial({color:0xC5BDB0,roughness:.85,metalness:.02});
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(8,4,5.5),wallM).translateX(chX).translateY(2.25).translateZ(chZ));
  // Metal roof (standing seam)
  const roofM=new THREE.MeshStandardMaterial({color:0x5A5A5A,roughness:.35,metalness:.72});
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(8.8,.12,6.2),roofM).translateX(chX).translateY(4.3).translateZ(chZ));
  // Roof overhang drip edge
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(9,.06,6.4),M.steel).translateX(chX).translateY(4.22).translateZ(chZ));
  // Standing seam ribs
  for(let rib3=0;rib3<12;rib3++){
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.02,.06,6.2),roofM).translateX(chX-4+rib3*.73).translateY(4.36).translateZ(chZ));
  }
  // Metal door (double)
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(2,3.2,.06),new THREE.MeshStandardMaterial({color:0x5C5C5C,roughness:.4,metalness:.55})).translateX(chX).translateY(1.85).translateZ(chZ-2.78));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.015,3,.002),new THREE.MeshStandardMaterial({color:0x222222})).translateX(chX).translateY(1.85).translateZ(chZ-2.82));
  // Door handle
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,.15,6),M.steel).translateX(chX+.15).translateY(1.9).translateZ(chZ-2.84));
  // Windows (narrow slit)
  for(let w=0;w<2;w++){
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(1,1,.06),new THREE.MeshStandardMaterial({color:0x6688AA,roughness:.08,metalness:.18,transparent:true,opacity:.65})).translateX(chX-2.5+w*5).translateY(3).translateZ(chZ-2.78));
  }
  // HVAC unit on side
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.2,1.5,.8),new THREE.MeshStandardMaterial({color:0xD8D4CC,roughness:.6,metalness:.2})).translateX(chX+4.6).translateY(1).translateZ(chZ));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.05,12),M.steel).translateX(chX+4.6).translateY(1.78).translateZ(chZ));

  // === CIRCUIT BREAKERS (SF6 dead-tank) ===
  for(let cb=0;cb<2;cb++){
    const cbX2=SX-5+cb*10,cbZ2=SZ+14;
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(3.5,.35,2.2),M.conc).translateX(cbX2).translateY(.17).translateZ(cbZ2));
    // Dead-tank body
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.2,2.2,1.5),new THREE.MeshStandardMaterial({color:0x505855,roughness:.45,metalness:.5})).translateX(cbX2).translateY(1.45).translateZ(cbZ2));
    // Mechanism cabinet
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(1,1.5,.9),new THREE.MeshStandardMaterial({color:0xD0CCC4,roughness:.65,metalness:.15})).translateX(cbX2-1.2).translateY(1.1).translateZ(cbZ2));
    // Bushings on top
    for(let bp=0;bp<3;bp++){
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.12,1.8,8),bushM).translateX(cbX2-.7+bp*.7).translateY(3.4).translateZ(cbZ2));
      for(let sk=0;sk<3;sk++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.18,.15,.06,10),bushM).translateX(cbX2-.7+bp*.7).translateY(2.7+sk*.35).translateZ(cbZ2));
      }
    }
  }

  // === DISCONNECT SWITCHES ===
  for(let ds=0;ds<3;ds++){
    const dsX=SX+9,dsZ=SZ-5+ds*5;
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(1,.3,.8),M.conc).translateX(dsX).translateY(.15).translateZ(dsZ));
    // Support insulators
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.12,2,8),bushM).translateX(dsX-.25).translateY(1.3).translateZ(dsZ));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.12,2,8),bushM).translateX(dsX+.25).translateY(1.3).translateZ(dsZ));
    // Blade arm
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.04,1.8,.03),M.steel).translateX(dsX).translateY(3).translateZ(dsZ).rotateZ(.5));
    // Operating mechanism
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.3,.6,.2),M.steel).translateX(dsX).translateY(.6).translateZ(dsZ-.3));
  }

  // === CURRENT/VOLTAGE TRANSFORMERS ===
  for(let ct=0;ct<3;ct++){
    const ctX=SX+6,ctZ=SZ-5+ct*5;
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.6,.2,.6),M.conc).translateX(ctX).translateY(.1).translateZ(ctZ));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.2,2.8,10),bushM).translateX(ctX).translateY(1.6).translateZ(ctZ));
    for(let sk=0;sk<5;sk++){
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.28,.24,.06,10),bushM).translateX(ctX).translateY(.5+sk*.5).translateZ(ctZ));
    }
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.25,.35,.25),M.steel).translateX(ctX).translateY(3.2).translateZ(ctZ));
  }

  // Junction/meter box near control house
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.5,2,1),new THREE.MeshStandardMaterial({color:0x606060,roughness:.42,metalness:.5})).translateX(SX-11).translateY(1.1).translateZ(SZ+6));

  // AC trench ‚Äî MV cable to substation
  const acLinkZ=Math.abs(SZ+20);
  for(let cab=0;cab<3;cab++)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.14,.14,acLinkZ,6),cableE).translateX(IX+35).translateY(.08).translateZ((SZ+20)/2+cab*.15).rotateX(Math.PI/2));
  const acTL=SX-IX-20;
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(acTL,.08,2),new THREE.MeshStandardMaterial({color:0x5a5045,roughness:.88,metalness:0})).translateX(IX+10+acTL/2).translateY(.04).translateZ(SZ+20));
  for(let cab=0;cab<3;cab++)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.14,.14,acTL,6),cableE).translateX(IX+10+acTL/2).translateY(.08).translateZ(SZ+19.4+cab*.3).rotateZ(Math.PI/2));

  // Grounding grid risers (visible copper rods)
  const groundM=new THREE.MeshStandardMaterial({color:0x8A6030,roughness:.55,metalness:.5});
  for(let gr=0;gr<6;gr++){
    const gx=SX-22+gr*9;
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.5,4),groundM).translateX(gx).translateY(.25).translateZ(SZ-20));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.15,.15,.06),groundM).translateX(gx).translateY(.08).translateZ(SZ-20));
  }

  // === TRANSMISSION TOWERS ===
  for(let tower=0;tower<3;tower++){const tX=SX+22+tower*28;
    // Lattice tower legs (tapered)
    for(let leg=0;leg<4;leg++){
      const lx=tX+((leg%2)-.5)*1.8;const lz=SZ+((Math.floor(leg/2))-.5)*1.8;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.06,.14,24,6),M.galv).translateX(lx).translateY(12).translateZ(lz));
      // Concrete footing
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.6,.3,.6),M.conc).translateX(lx).translateY(.15).translateZ(lz));
    }
    // Cross bracing (X pattern at intervals)
    for(let h2=0;h2<5;h2++){
      const bY=2+h2*4.5;const spread=1.8-.15*h2;
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,Math.sqrt(spread*spread+16),4),M.galv).translateX(tX).translateY(bY+2).translateZ(SZ-spread/2).rotateX(.4));
      sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,Math.sqrt(spread*spread+16),4),M.galv).translateX(tX).translateY(bY+2).translateZ(SZ+spread/2).rotateX(-.4));
    }
    // Cross arm (wide)
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(16,.2,.25),M.galv).translateX(tX).translateY(22).translateZ(SZ));
    // Arm extensions for conductor attachment
    for(let ext=-1;ext<=1;ext++){
      sc.add(new THREE.Mesh(new THREE.BoxGeometry(.15,2.2,.15),M.galv).translateX(tX+ext*6).translateY(23).translateZ(SZ));
      // Insulator strings
      for(let disc=0;disc<8;disc++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.1,.1,8),bushM).translateX(tX+ext*6).translateY(21.2-disc*.18).translateZ(SZ));
      }
    }
    // Conductors between towers
    if(tower<2){
      for(let cond=0;cond<3;cond++){
        sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,28,4),new THREE.MeshStandardMaterial({color:0x444444,roughness:.4,metalness:.6})).translateX(tX+14).translateY(20-.1*cond).translateZ(SZ-6+cond*6).rotateZ(Math.PI/2));
      }
    }
  }

  // LABELS: Substation + Transmission + Sub-Components
  addSign('Substation (34.5 kV)',SX,14,SZ,{scale:1.6});
  addSign('Main Power Transformer',SX,txH+6,SZ-txD/2-2,{scale:.85});
  addSign('Control House',chX,6,chZ,{scale:.8});
  addSign('HV Bus Structure',SX-1,13.5,SZ-9,{scale:.7,maxWidth:280});
  addSign('SF6 Circuit Breakers',SX-5,5,SZ+14,{scale:.65,maxWidth:280});
  addSign('Disconnect Switches',SX+9,4.5,SZ-5,{scale:.6,maxWidth:280});
  addSign('CT/VT Instruments',SX+6,5,SZ,{scale:.6,maxWidth:260});
  addSign('Transmission Line (138 kV)',SX+50,26,SZ,{scale:1.2,maxWidth:380});
  // MV trench cable tag
  addCableTag('MV Cable Trench (34.5 kV)',IX+35,.08,(SZ+20)/2);
  addCableTag('MV Cable Trench',IX+10+acTL/2,.08,SZ+21);
  waypoints.push({name:'Substation',color:'#DDAA00',target:{x:SX,y:4,z:SZ},cam:{x:SX-25,y:18,z:SZ+30}});
  waypoints.push({name:'Main Transformer',color:'#4A7248',target:{x:SX,y:4,z:SZ},cam:{x:SX-10,y:8,z:SZ+12}});
  waypoints.push({name:'Switchyard & Bus',color:'#CCD0D8',target:{x:SX,y:8,z:SZ-9},cam:{x:SX+8,y:12,z:SZ-9+18}});
  waypoints.push({name:'Transmission Towers',color:'#888888',target:{x:SX+50,y:12,z:SZ},cam:{x:SX+40,y:20,z:SZ+35}});

  const F={x1:X0-22,x2:SX+75,z1:Z0-22,z2:-Z0+22};

  // ‚ïê‚ïê‚ïê ROADS ‚ïê‚ïê‚ïê
  const rdT=mkGravelTex();rdT.repeat.set(1,15);
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(5,F.z2-F.z1+30),new THREE.MeshStandardMaterial({map:rdT,roughness:.8,metalness:0})).translateX(F.x1-5).translateY(.07).rotateX(-Math.PI/2));
  const rdT2=mkGravelTex();rdT2.repeat.set(15,1);
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(F.x2-F.x1-10,4),new THREE.MeshStandardMaterial({map:rdT2,roughness:.8,metalness:0})).translateX((F.x1+F.x2)/2).translateY(.06).translateZ(F.z2-6).rotateX(-Math.PI/2));

  // ‚ïê‚ïê‚ïê O&M BUILDING ‚ïê‚ïê‚ïê
  const omX=F.x1+12,omZ=F.z2-10;gpad(omX,omZ,16,12);
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(12,3.8,8),M.bldg).translateX(omX).translateY(1.9).translateZ(omZ));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(12.4,.2,8.4),M.roof).translateX(omX).translateY(3.9).translateZ(omZ));
  for(let w=0;w<3;w++)sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.2,1.0,.06),new THREE.MeshStandardMaterial({color:0x88AACC,roughness:.1,metalness:.2,transparent:true,opacity:.6})).translateX(omX-4+w*3).translateY(2.2).translateZ(omZ-4.04));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(1.6,2.6,.06),new THREE.MeshStandardMaterial({color:0x445566,roughness:.5,metalness:.3})).translateX(omX+3).translateY(1.3).translateZ(omZ-4.04));
  addSign('O&M Building',omX,5.5,omZ,{scale:.9});
  waypoints.push({name:'O&M Building',color:'#C5BDB0',target:{x:omX,y:2,z:omZ},cam:{x:omX-12,y:6,z:omZ+15}});

  // ‚ïê‚ïê‚ïê WEATHER STATION ‚ïê‚ïê‚ïê
  const wsX=F.x1+6,wsZ=F.z1+6;
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,7,6),M.steel).translateX(wsX).translateY(3.5).translateZ(wsZ));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,.06,10),M.white).translateX(wsX).translateY(7.1).translateZ(wsZ));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.4,.6,.25),M.white).translateX(wsX).translateY(2.2).translateZ(wsZ));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(.8,.4,.025),M.pnl).translateX(wsX+1.5).translateY(4.5).translateZ(wsZ));
  addSign('Weather Station',wsX,8.5,wsZ,{scale:.7});

  // ‚ïê‚ïê‚ïê PERIMETER FENCING with barbed wire ‚ïê‚ïê‚ïê
  const fenceH=2.4;
  // Individual posts & panels per side
  for(let fx=F.x1;fx<=F.x2;fx+=3){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,fenceH,6),M.fP).translateX(fx).translateY(fenceH/2).translateZ(F.z1));if(fx<F.x2)sc.add(new THREE.Mesh(new THREE.PlaneGeometry(3,fenceH),M.fence).translateX(fx+1.5).translateY(fenceH/2).translateZ(F.z1))}
  for(let fx=F.x1;fx<=F.x2;fx+=3){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,fenceH,6),M.fP).translateX(fx).translateY(fenceH/2).translateZ(F.z2));if(fx<F.x2)sc.add(new THREE.Mesh(new THREE.PlaneGeometry(3,fenceH),M.fence).translateX(fx+1.5).translateY(fenceH/2).translateZ(F.z2))}
  for(let fz=F.z1;fz<=F.z2;fz+=3){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,fenceH,6),M.fP).translateX(F.x1).translateY(fenceH/2).translateZ(fz));if(fz<F.z2)sc.add(new THREE.Mesh(new THREE.PlaneGeometry(3,fenceH),M.fence).translateX(F.x1).translateY(fenceH/2).translateZ(fz+1.5).rotateY(Math.PI/2))}
  for(let fz=F.z1;fz<=F.z2;fz+=3){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,fenceH,6),M.fP).translateX(F.x2).translateY(fenceH/2).translateZ(fz));if(fz<F.z2)sc.add(new THREE.Mesh(new THREE.PlaneGeometry(3,fenceH),M.fence).translateX(F.x2).translateY(fenceH/2).translateZ(fz+1.5).rotateY(-Math.PI/2))}
  // Barbed wire
  const bwMat=new THREE.MeshStandardMaterial({color:0x555555,roughness:.6,metalness:.7});
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.008,.008,F.x2-F.x1,3),bwMat).translateX((F.x1+F.x2)/2).translateY(fenceH+.1).translateZ(F.z1).rotateZ(Math.PI/2));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.008,.008,F.x2-F.x1,3),bwMat).translateX((F.x1+F.x2)/2).translateY(fenceH+.1).translateZ(F.z2).rotateZ(Math.PI/2));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.008,.008,F.z2-F.z1,3),bwMat).translateX(F.x1).translateY(fenceH+.1).translateZ((F.z1+F.z2)/2).rotateX(Math.PI/2));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.008,.008,F.z2-F.z1,3),bwMat).translateX(F.x2).translateY(fenceH+.1).translateZ((F.z1+F.z2)/2).rotateX(Math.PI/2));

  // ‚ïê‚ïê‚ïê MAIN GATE ‚ïê‚ïê‚ïê
  const gateX=(F.x1+F.x2)/2,gateW=6;
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,3,8),M.fP).translateX(gateX-gateW/2).translateY(1.5).translateZ(F.z2));
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,3,8),M.fP).translateX(gateX+gateW/2).translateY(1.5).translateZ(F.z2));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(gateW,.05,2.2),new THREE.MeshStandardMaterial({color:0x666666,roughness:.4,metalness:.75})).translateX(gateX).translateY(1.1).translateZ(F.z2-.3));
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(gateW/2-.2,2),M.fence).translateX(gateX-gateW/4).translateY(1.1).translateZ(F.z2-.3));
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(gateW/2-.2,2),M.fence).translateX(gateX+gateW/4).translateY(1.1).translateZ(F.z2-.3));
  addSign('Main Gate',gateX,3.5,F.z2,{scale:.7});
  addSign('Perimeter Road',F.x1-5,2.5,0,{scale:.7,maxWidth:240});

  // ‚ïê‚ïê‚ïê ENTRANCE SIGN ‚ïê‚ïê‚ïê
  sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,2.5,6),M.fP).translateX(gateX-4).translateY(1.25).translateZ(F.z2+3));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(3,1.5,.08),M.white).translateX(gateX-4).translateY(2.3).translateZ(F.z2+3));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(2.8,.6,.01),new THREE.MeshStandardMaterial({color:0x2563EB,roughness:.3,metalness:.2})).translateX(gateX-4).translateY(2.6).translateZ(F.z2+3.05));

  // ‚ïê‚ïê‚ïê WARNING SIGNS ‚ïê‚ïê‚ïê
  [{x:F.x1+10,z:F.z1+.5,r:0},{x:F.x2-10,z:F.z1+.5,r:0},{x:F.x1+.5,z:0,r:Math.PI/2},{x:F.x2-.5,z:0,r:-Math.PI/2}].forEach(ws=>{
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.03,.03,1.8,6),M.fP).translateX(ws.x).translateY(.9).translateZ(ws.z));
    const wSign=new THREE.Mesh(new THREE.BoxGeometry(.6,.6,.02),M.warn);wSign.position.set(ws.x,1.6,ws.z);wSign.rotation.y=ws.r;sc.add(wSign);
  });

  // ‚ïê‚ïê‚ïê SITE LIGHTING ‚ïê‚ïê‚ïê
  const lightPoles=[{x:F.x1+15,z:F.z2-10},{x:F.x2-15,z:F.z2-10},{x:F.x1+15,z:F.z1+10},{x:F.x2-15,z:F.z1+10},{x:gateX,z:F.z2+5}];
  lightPoles.forEach(lp=>{
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.1,8,8),new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.4,metalness:.6})).translateX(lp.x).translateY(4).translateZ(lp.z));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.15,.18,.3,8),M.conc).translateX(lp.x).translateY(.15).translateZ(lp.z));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.4,.15,.25),new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.3,metalness:.5})).translateX(lp.x).translateY(7.9).translateZ(lp.z));
    sc.add(new THREE.Mesh(new THREE.BoxGeometry(.35,.05,.2),new THREE.MeshStandardMaterial({color:0xffffee,roughness:.1,metalness:.1,transparent:true,opacity:.3})).translateX(lp.x).translateY(7.82).translateZ(lp.z));
  });

  // ‚ïê‚ïê‚ïê SECURITY CAMERAS ‚ïê‚ïê‚ïê
  lightPoles.slice(0,3).forEach(lp=>{
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,.8,6),M.steel).translateX(lp.x+.35).translateY(7.5).translateZ(lp.z).rotateZ(Math.PI/3));
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.06,.08,.2,8),new THREE.MeshStandardMaterial({color:0xeeeeee,roughness:.2,metalness:.6})).translateX(lp.x+.65).translateY(7.2).translateZ(lp.z).rotateZ(Math.PI/2));
  });

  // ‚ïê‚ïê‚ïê PARKING AREA ‚ïê‚ïê‚ïê
  const parkX=F.x1+20,parkZ=F.z2-18;
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(14,10),new THREE.MeshStandardMaterial({color:0x2a2a2a,roughness:.85,metalness:.05})).translateX(parkX).translateY(.05).translateZ(parkZ).rotateX(-Math.PI/2));
  for(let ps=0;ps<4;ps++)sc.add(new THREE.Mesh(new THREE.PlaneGeometry(.15,8),new THREE.MeshStandardMaterial({color:0xeeeeee,roughness:.7})).translateX(parkX-5+ps*3.5).translateY(.06).translateZ(parkZ).rotateX(-Math.PI/2));
  sc.add(new THREE.Mesh(new THREE.BoxGeometry(14.2,.15,.2),new THREE.MeshStandardMaterial({color:0x888880,roughness:.8,metalness:.05})).translateX(parkX).translateY(.075).translateZ(parkZ-5.1));
  addSign('Parking',parkX,2.5,parkZ,{scale:.6});

  // ‚ïê‚ïê‚ïê DRAINAGE ‚ïê‚ïê‚ïê
  sc.add(new THREE.Mesh(new THREE.PlaneGeometry(2,F.z2-F.z1),new THREE.MeshStandardMaterial({color:0x5a4a3a,roughness:.95,metalness:0})).translateX(F.x1-8).translateY(.02).rotateX(-Math.PI/2));
  for(let cu=-20;cu<=20;cu+=40)sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,5,8),new THREE.MeshStandardMaterial({color:0x3a3a3a,roughness:.5,metalness:.3})).translateX(F.x1-5).translateY(.2).translateZ(cu).rotateZ(Math.PI/2));

  // ‚ïê‚ïê‚ïê VEGETATION ‚ïê‚ïê‚ïê
  function makePine(x,z,s){
    const th=4*s;sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08*s,.12*s,th,6),M.bark).translateX(x).translateY(th/2).translateZ(z));
    for(let l=0;l<3;l++)sc.add(new THREE.Mesh(new THREE.ConeGeometry((.5-l*.12)*s,.8*s,8),M.canopy).translateX(x).translateY(th+.3+l*.6*s).translateZ(z));
  }
  function makeBush(x,z,s){const b=new THREE.Mesh(new THREE.SphereGeometry(.3*s,6,5),M.bush);b.position.set(x,.2*s,z);b.scale.y=.7;sc.add(b)}
  for(let tx=F.x1+8;tx<F.x2-8;tx+=12+R()*6){if(Math.abs(tx-gateX)<15)continue;makePine(tx,F.z1-2,.8+R()*.4);makePine(tx,F.z2+2,.8+R()*.4)}
  for(let tz=F.z1+8;tz<F.z2-8;tz+=12+R()*6){makePine(F.x1-2,tz,.8+R()*.4);makePine(F.x2+2,tz,.8+R()*.4)}
  for(let b=0;b<6;b++){makeBush(omX-6+R()*2,omZ+4+R()*2,.8+R()*.4);makeBush(omX+6-R()*2,omZ+4+R()*2,.8+R()*.4)}
  for(let vp=0;vp<25;vp++){const vx=F.x1+R()*(F.x2-F.x1),vz=F.z1+R()*(F.z2-F.z1);if(vx>X0-5&&vx<RL/2+5&&vz>Z0-5&&vz<-Z0+5)continue;makeBush(vx,vz,.4+R()*.3)}

  // ‚ïê‚ïê‚ïê ROCKS ‚ïê‚ïê‚ïê
  for(let rk=0;rk<40;rk++){const rx=F.x1+R()*(F.x2-F.x1),rz=F.z1+R()*(F.z2-F.z1);if(rx>X0-5&&rx<RL/2+5&&rz>Z0-5&&rz<-Z0+5)continue;const rs=.1+R()*.25;
    const rock=new THREE.Mesh(new THREE.DodecahedronGeometry(rs,0),new THREE.MeshStandardMaterial({color:0x6a6560,roughness:.95,metalness:0}));rock.position.set(rx,rs*.5,rz);rock.rotation.set(R()*Math.PI,R()*Math.PI,R()*Math.PI);sc.add(rock)}

  // ‚ïê‚ïê‚ïê TIRE TRACKS ‚ïê‚ïê‚ïê
  const trackMat=new THREE.MeshStandardMaterial({color:0x4a3a2a,roughness:.95,metalness:0});
  for(let tr=0;tr<15;tr++){sc.add(new THREE.Mesh(new THREE.PlaneGeometry(.3,2),trackMat).translateX(F.x1-6.5).translateY(.085).translateZ(Z0+tr*5).rotateX(-Math.PI/2));sc.add(new THREE.Mesh(new THREE.PlaneGeometry(.3,2),trackMat).translateX(F.x1-4.5).translateY(.085).translateZ(Z0+tr*5).rotateX(-Math.PI/2))}

  // ‚ïê‚ïê‚ïê UTILITY BOXES ‚ïê‚ïê‚ïê
  for(let ub=0;ub<4;ub++){const ubX=F.x1+25+ub*30;sc.add(new THREE.Mesh(new THREE.BoxGeometry(.6,.8,.4),new THREE.MeshStandardMaterial({color:0x4a4a4a,roughness:.4,metalness:.5})).translateX(ubX).translateY(.4).translateZ(F.z1+8));sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.01,.01,1.2,4),M.steel).translateX(ubX).translateY(1.4).translateZ(F.z1+8))}

  // ‚ïê‚ïê‚ïê ROW MARKERS ‚ïê‚ïê‚ïê
  for(let r=0;r<ROWS;r++){const rz=Z0+r*RS;sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.025,.025,1.5,6),M.warn).translateX(X0-3).translateY(.75).translateZ(rz));sc.add(new THREE.Mesh(new THREE.BoxGeometry(.15,.15,.02),new THREE.MeshStandardMaterial({color:0xffffff,roughness:.4})).translateX(X0-3).translateY(1.5).translateZ(rz))}

  // ‚ïê‚ïê‚ïê WEATHER SENSORS ‚ïê‚ïê‚ïê
  [{x:F.x1+30,z:F.z1+30},{x:F.x2-30,z:F.z2-30}].forEach((ws,i)=>{
    sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.025,.025,4,6),M.steel).translateX(ws.x).translateY(2).translateZ(ws.z));
    if(i===0)for(let cup=0;cup<3;cup++){sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.01,.01,.3,4),M.steel).translateX(ws.x).translateY(4).translateZ(ws.z).rotateZ(Math.PI/2).rotateY(cup*Math.PI*2/3));sc.add(new THREE.Mesh(new THREE.SphereGeometry(.04,6,6),M.white).translateX(ws.x+Math.cos(cup*Math.PI*2/3)*.3).translateY(4).translateZ(ws.z+Math.sin(cup*Math.PI*2/3)*.3))}
    else sc.add(new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,.3,8),M.white).translateX(ws.x).translateY(4.15).translateZ(ws.z));
  });

  // ‚ïê‚ïê‚ïê DIRT PATCHES ‚ïê‚ïê‚ïê
  const dirtMat=new THREE.MeshStandardMaterial({color:0x7a6a55,roughness:.98,metalness:0});
  for(let dp=0;dp<8;dp++)sc.add(new THREE.Mesh(new THREE.CircleGeometry(1.5+R(),8),dirtMat).translateX(F.x1-6+R()*2).translateY(.08).translateZ(Z0+dp*RS+R()*3).rotateX(-Math.PI/2));

  return {signs, waypoints}; // for billboard rotation and navigation
}

// ‚ïê‚ïê‚ïê VALID SITE CONFIGURATIONS ‚ïê‚ïê‚ïê
// module '*' = works with both module types
const validSites=[
  // Bifacial-only configs (string homeruns)
  {module:'bifacial-600',inverter:'distributed',dcCollection:'string-homeruns',dcCombo:'none'},           // Bi1
  {module:'bifacial-600',inverter:'centralized-cluster',dcCollection:'string-homeruns',dcCombo:'combiner-boxes'}, // Bi2
  {module:'bifacial-600',inverter:'central',dcCollection:'string-homeruns',dcCombo:'combiner-boxes'},     // Bi3
  // Both modules ‚Äî harnesses
  {module:'*',inverter:'distributed',dcCollection:'harnesses',dcCombo:'none'},                            // Bi4 + FS1
  {module:'*',inverter:'centralized-cluster',dcCollection:'harnesses',dcCombo:'combiner-boxes'},          // Bi5 + FS2
  {module:'*',inverter:'central',dcCollection:'harnesses',dcCombo:'combiner-boxes'},                      // Bi6 + FS3
  // Both modules ‚Äî trunk bus
  {module:'*',inverter:'centralized-cluster',dcCollection:'trunk-bus',dcCombo:'lbds'},                    // Bi7 + FS4
  {module:'*',inverter:'central',dcCollection:'trunk-bus',dcCombo:'lbds'},                                // Bi8 + FS5
];

const sbState={module:null,inverter:null,dcCollection:null,dcCombo:null};
const fields=['module','inverter','dcCollection','dcCombo'];

function fm(siteVal,stateVal){return !stateVal||siteVal==='*'||siteVal===stateVal}

function sbUpdateUI(){
  // Enable/disable cards based on what's still valid
  fields.forEach(field=>{
    const container=document.querySelector('.cfg-cards[data-field="'+field+'"]');
    if(!container)return;
    container.querySelectorAll('.cfg-card').forEach(card=>{
      const val=card.dataset.value;
      const test={...sbState};test[field]=val;
      const isValid=validSites.some(s=>fm(s.module,test.module)&&fm(s.inverter,test.inverter)&&fm(s.dcCollection,test.dcCollection)&&fm(s.dcCombo,test.dcCombo));
      card.classList.toggle('cfg-disabled',!isValid);
      card.classList.toggle('cfg-selected',sbState[field]===val);
    });
  });

  // Step tabs
  fields.forEach((f,i)=>{
    const tab=document.getElementById('st'+i);
    if(!tab)return;
    const filled=sbState[f]!==null;
    tab.classList.toggle('done',filled);
    // Active = first unfilled
    const isActive=!filled&&fields.slice(0,i).every(pf=>sbState[pf]!==null);
    tab.classList.toggle('active',isActive);
  });

  // Status
  const count=fields.filter(f=>sbState[f]!==null).length;
  const allSelected=count===4;
  const isValidConfig=allSelected&&validSites.some(s=>(s.module==='*'||s.module===sbState.module)&&s.inverter===sbState.inverter&&s.dcCollection===sbState.dcCollection&&s.dcCombo===sbState.dcCombo);
  const status=document.getElementById('sbStatus');
  const buildBtn=document.getElementById('buildBtn');
  if(isValidConfig){
    const moduleMax=sbState.module==='bifacial-600'?8:5;
    const moduleConfigs=validSites.filter(s=>s.module===sbState.module||s.module==='*');
    const idx=moduleConfigs.findIndex(s=>s.inverter===sbState.inverter&&s.dcCollection===sbState.dcCollection&&s.dcCombo===sbState.dcCombo);
    status.textContent='‚úÖ Valid ‚Äî Site '+(idx>=0?idx+1:'?')+' of '+moduleMax;
    status.style.color='#34d399';
  }else if(allSelected){
    status.textContent='‚ùå Invalid combination';
    status.style.color='#f87171';
  }else{
    status.textContent=count+' of 4 selected';
    status.style.color='rgba(255,255,255,.3)';
  }
  buildBtn.classList.toggle('visible',isValidConfig);
}

// Card click handlers
document.querySelectorAll('.cfg-card').forEach(card=>{
  card.addEventListener('click',()=>{
    if(card.classList.contains('cfg-disabled'))return;
    const field=card.parentElement.dataset.field;
    const val=card.dataset.value;
    sbState[field]=sbState[field]===val?null:val;
    sbUpdateUI();
  });
});

// Start Over
document.getElementById('startOverBtn').addEventListener('click',()=>{
  sbState.module=null;sbState.inverter=null;sbState.dcCollection=null;sbState.dcCombo=null;
  sbUpdateUI();
});

// Build Site ‚Äî transition from modal to 3D
let sceneReady=false;
document.getElementById('buildBtn').addEventListener('click',()=>{
  if(!sbState.module||!sbState.inverter||!sbState.dcCollection||!sbState.dcCombo)return;
  // Hide modal
  document.getElementById('modal').classList.add('hidden');
  // Show loading
  const ld=document.getElementById('loading');
  ld.classList.add('active');
  setTimeout(()=>{
    if(!sceneReady){initScene();sceneReady=true}
    buildScene();
    // Hide loading, reveal 3D overlays
    setTimeout(()=>{
      ld.classList.remove('active');
      document.getElementById('ui').classList.add('visible');
      document.getElementById('info').classList.add('visible');
      document.getElementById('editCfgBtn').classList.add('visible');
      document.getElementById('nav').classList.add('visible');
    },400);
  },100);
});

// Close modal (only if scene is ready)
document.getElementById('modalCloseBtn').addEventListener('click',()=>{
  if(sceneReady){
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('ui').classList.add('visible');
    document.getElementById('info').classList.add('visible');
    document.getElementById('editCfgBtn').classList.add('visible');
    document.getElementById('nav').classList.add('visible');
  }
});

// Edit Configuration ‚Äî re-show modal
document.getElementById('editCfgBtn').addEventListener('click',()=>{
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('editCfgBtn').classList.remove('visible');
  document.getElementById('legend').classList.remove('visible');
  document.getElementById('legendToggle').classList.remove('visible');
  document.getElementById('nav').classList.remove('visible');
});

var scene,camera,renderer,controls;

function initScene(){
  scene=new THREE.Scene();scene.background=new THREE.Color(0x87CEEB);scene.fog=new THREE.FogExp2(0x87CEEB,.0012);
  camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,.5,1200);camera.position.set(-80,60,100);
  renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.15;renderer.outputEncoding=THREE.sRGBEncoding;
  document.body.appendChild(renderer.domElement);
  controls=new THREE.OrbitControls(camera,renderer.domElement);controls.target.set(0,2,0);controls.enableDamping=true;controls.dampingFactor=.08;
  const sun=new THREE.DirectionalLight(0xfff5e0,1.6);sun.position.set(80,100,-40);sun.castShadow=true;sun.shadow.mapSize.set(4096,4096);sun.shadow.camera.left=-180;sun.shadow.camera.right=180;sun.shadow.camera.top=180;sun.shadow.camera.bottom=-180;sun.shadow.camera.far=500;sun.shadow.bias=-.0005;sun.shadow.normalBias=.02;scene.add(sun);
  const fill=new THREE.DirectionalLight(0xaabbdd,.35);fill.position.set(-60,30,80);scene.add(fill);
  scene.add(new THREE.AmbientLight(0x8ab4f0,.42));scene.add(new THREE.HemisphereLight(0x88bbff,0x445522,.60));
  const skyGeo=new THREE.SphereGeometry(500,16,16);
  const skyMat=new THREE.ShaderMaterial({uniforms:{topColor:{value:new THREE.Color(0x4488cc)},bottomColor:{value:new THREE.Color(0xccddee)},offset:{value:20},exponent:{value:.4}},vertexShader:'varying vec3 vWP;void main(){vec4 wp=modelMatrix*vec4(position,1.0);vWP=wp.xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}',fragmentShader:'uniform vec3 topColor;uniform vec3 bottomColor;uniform float offset;uniform float exponent;varying vec3 vWP;void main(){float h=normalize(vWP+vec3(0,offset,0)).y;gl_FragColor=vec4(mix(bottomColor,topColor,max(pow(max(h,0.0),exponent),0.0)),1.0);}',side:THREE.BackSide});
  scene.add(new THREE.Mesh(skyGeo,skyMat));
  animate();
}
function clearScene(){svSigns=[];svWaypoints=[];flyState=null;const children=[...scene.children];children.forEach(c=>{if(!c.isLight&&!(c.material&&c.material.isShaderMaterial)){scene.remove(c);if(c.geometry)c.geometry.dispose();if(c.material){if(Array.isArray(c.material))c.material.forEach(m=>m.dispose());else c.material.dispose()}}})}
function buildScene(){
  clearScene();
  const isFS=sbState.module==='first-solar';
  const isBi=sbState.module==='bifacial-600';
  const inv=sbState.inverter||'distributed';
  const dc=sbState.dcCollection||'string-homeruns';
  const comb=sbState.dcCombo||'none';
  const result=svBuildSite(scene,inv,dc,comb,isBi,isFS);
  svSigns=result.signs;
  svWaypoints=result.waypoints;
  populateNav();
  const modLabel=isFS?'First Solar S6+ 525W':'Bifacial 600W';
  const strLabel=isFS?'6 modules/string':'28 modules/string';
  document.getElementById('info').innerHTML='Orbit: drag ¬∑ Zoom: scroll ¬∑ Pan: right-drag<br>'+modLabel+' ¬∑ '+strLabel;
  // ‚ïê‚ïê‚ïê UPDATE LEGEND ‚ïê‚ïê‚ïê
  const dcName={'string-homeruns':'String Homeruns','harnesses':'DC Harnesses (Y-Conn)','trunk-bus':'Trunk Bus'}[dc];
  const combName={'none':'Direct (No Combiner)','combiner-boxes':'Combiner Boxes','lbds':'Load Break Disconnects'}[comb];
  const invName={'distributed':'String Inverters (Distributed)','centralized-cluster':'Inverter Cluster (Centralized)','central':'Central Inverter'}[inv];
  const leg=document.getElementById('legend');
  leg.classList.add('visible');
  let h='<h3><span>Power Flow Path</span><button class="leg-hide" onclick="toggleLegend(false)">Hide</button></h3>';
  let step=1;
  h+='<div class="leg-item"><div class="leg-color" style="background:#3858A0"></div><div class="leg-label">'+step+'. '+modLabel+'</div></div>';
  h+='<div class="leg-arrow">‚Üì USE-2 PV wire (red/black)</div>';step++;
  h+='<div class="leg-item"><div class="leg-color" style="background:#EE6600"></div><div class="leg-label">'+step+'. '+dcName+'</div></div>';
  h+='<div class="leg-equip">Orange PVC conduit ¬∑ Sch 40</div>';step++;
  if(comb!=='none'){
    h+='<div class="leg-arrow">‚Üì DC feeder conduit</div>';
    h+='<div class="leg-item"><div class="leg-color" style="background:#1560CC"></div><div class="leg-label">'+step+'. '+combName+'</div></div>';
    h+='<div class="leg-equip">Blue HDPE conduit ¬∑ direct buried</div>';step++;
  }
  h+='<div class="leg-arrow">‚Üì DC/AC conversion</div>';
  h+='<div class="leg-item"><div class="leg-color" style="background:#1A7A68"></div><div class="leg-label">'+step+'. '+invName+'</div></div>';step++;
  h+='<div class="leg-arrow">‚Üì EMT conduit (AC)</div>';
  h+='<div class="leg-item"><div class="leg-color" style="background:#CCD0D8"></div><div class="leg-label">'+step+'. Step-Up Transformer</div></div>';
  h+='<div class="leg-equip">Chrome EMT ¬∑ 3-phase AC</div>';step++;
  h+='<div class="leg-arrow">‚Üì MV XLPE cable</div>';
  h+='<div class="leg-item"><div class="leg-color" style="background:#DDAA00"></div><div class="leg-label">'+step+'. Substation ‚Üí Grid</div></div>';
  h+='<div class="leg-equip">Yellow MV jacket ¬∑ 34.5 kV</div>';
  leg.innerHTML=h;
  leg.classList.add('visible');
  document.getElementById('legendToggle').classList.remove('visible');
}
function toggleLegend(show){
  const leg=document.getElementById('legend');
  const btn=document.getElementById('legendToggle');
  if(show){leg.classList.add('visible');btn.classList.remove('visible')}
  else{leg.classList.remove('visible');btn.classList.add('visible')}
}
document.getElementById('legendToggle').addEventListener('click',()=>toggleLegend(true));
let svSigns=[];
let svWaypoints=[];
// ‚ïê‚ïê‚ïê FLY-TO CAMERA ANIMATION ‚ïê‚ïê‚ïê
let flyState=null; // {from:{pos,target}, to:{pos,target}, t:0, duration:1.5}
function flyTo(camPos,targetPos,duration){
  if(!camera||!controls)return;
  flyState={
    fromPos:camera.position.clone(),
    fromTarget:controls.target.clone(),
    toPos:new THREE.Vector3(camPos.x,camPos.y,camPos.z),
    toTarget:new THREE.Vector3(targetPos.x,targetPos.y,targetPos.z),
    t:0, duration:duration||1.5
  };
}
function updateFly(dt){
  if(!flyState)return;
  flyState.t+=dt/flyState.duration;
  if(flyState.t>=1){flyState.t=1}
  // Smooth ease-in-out
  const t=flyState.t;
  const ease=t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;
  camera.position.lerpVectors(flyState.fromPos,flyState.toPos,ease);
  controls.target.lerpVectors(flyState.fromTarget,flyState.toTarget,ease);
  if(flyState.t>=1)flyState=null;
}

function populateNav(){
  const list=document.getElementById('nav-list');
  list.innerHTML='';
  svWaypoints.forEach((wp,i)=>{
    if(i===1){
      list.appendChild(Object.assign(document.createElement('div'),{className:'nav-sep'}));
    }
    const btn=document.createElement('button');btn.className='nav-btn';
    const keyHint=i<9?'<span style="opacity:.35;font-size:9px;margin-left:auto">'+(i+1)+'</span>':'';
    btn.innerHTML='<span class="nav-dot" style="background:'+wp.color+'"></span><span style="flex:1">'+wp.name+'</span>'+keyHint;
    btn.onclick=()=>{navIdx=i;flyTo(wp.cam,wp.target,wp.overview?2:1.5);setActiveNav(btn)};
    list.appendChild(btn);
  });
}
function setActiveNav(btn){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function animate(){
  requestAnimationFrame(animate);
  updateFly(1/60);
  controls.update();
  // Billboard: rotate all signs to face camera
  for(let i=0;i<svSigns.length;i++)svSigns[i].lookAt(camera.position);
  renderer.render(scene,camera);
}
addEventListener('resize',()=>{if(camera){camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)}});

// ‚ïê‚ïê‚ïê KEYBOARD NAV ‚ïê‚ïê‚ïê
let navIdx=-1;
addEventListener('keydown',(e)=>{
  if(!sceneReady||!svWaypoints.length)return;
  const key=e.key;
  // Number keys 1-9
  if(key>='1'&&key<='9'){
    const i=parseInt(key)-1;
    if(i<svWaypoints.length){
      navIdx=i;
      const wp=svWaypoints[i];
      flyTo(wp.cam,wp.target,1.5);
      const btns=document.querySelectorAll('.nav-btn');
      if(btns[i])setActiveNav(btns[i]);
    }
    return;
  }
  // Arrow left/right = prev/next
  if(key==='ArrowRight'||key==='ArrowLeft'){
    e.preventDefault();
    const dir=key==='ArrowRight'?1:-1;
    navIdx=(navIdx+dir+svWaypoints.length)%svWaypoints.length;
    const wp=svWaypoints[navIdx];
    flyTo(wp.cam,wp.target,1.2);
    const btns=document.querySelectorAll('.nav-btn');
    if(btns[navIdx])setActiveNav(btns[navIdx]);
  }
});

// Boot ‚Äî just show the modal, no auto-build
sbUpdateUI();
</script>
</body>
</html>
