<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ampacity Renewables — HSAT Site Designer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: 'Segoe UI', 'SF Pro Display', -apple-system, sans-serif; background: #060b17; }
    #root { width: 100%; height: 100vh; }
    /* Back to Education link */
    .back-to-education {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(6,11,23,0.92);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,212,255,0.3);
      border-radius: 8px;
      padding: 8px 14px;
      color: #00d4ff;
      font-size: 12px;
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .back-to-education:hover {
      border-color: rgba(0,212,255,0.6);
      background: rgba(6,11,23,1);
      box-shadow: 0 0 15px rgba(0,212,255,0.15);
    }
  </style>
</head>
<body>
  <a href="Ampacity_Renewables_Solar_Education.html" class="back-to-education">← Back to Education</a>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

const VALID_PATHS = [
  { module:"bifacial",inverter:"distributed",dcCollection:"homeruns",dcCombination:"none",id:"B1",cls:"A" },
  { module:"bifacial",inverter:"cluster",dcCollection:"harnesses",dcCombination:"combiner",id:"B2",cls:"B" },
  { module:"bifacial",inverter:"central",dcCollection:"harnesses",dcCombination:"combiner",id:"B3",cls:"C" },
  { module:"bifacial",inverter:"cluster",dcCollection:"trunk",dcCombination:"lbd",id:"B7",cls:"B" },
  { module:"bifacial",inverter:"central",dcCollection:"trunk",dcCombination:"lbd",id:"B8",cls:"C" },
  { module:"firstsolar",inverter:"distributed",dcCollection:"homeruns",dcCombination:"none",id:"FS1",cls:"A" },
  { module:"firstsolar",inverter:"cluster",dcCollection:"harnesses",dcCombination:"combiner",id:"FS2",cls:"B" },
  { module:"firstsolar",inverter:"central",dcCollection:"harnesses",dcCombination:"combiner",id:"FS3",cls:"C" },
  { module:"firstsolar",inverter:"cluster",dcCollection:"trunk",dcCombination:"lbd",id:"FS4",cls:"B" },
  { module:"firstsolar",inverter:"central",dcCollection:"trunk",dcCombination:"lbd",id:"FS5",cls:"C" },
];
const MOD={bifacial:{name:"Bifacial 600W",sub:"28 mods/string",watt:600,w:1.134,h:2.278,strLen:28},firstsolar:{name:"First Solar 525W",sub:"6 mods/string",watt:525,w:1.2,h:2.0,strLen:6}};
const INV_OPTS=[{key:"distributed",name:"Distributed String Inverters",sub:"Individual inverters per string",invPer:3},{key:"cluster",name:"Centralized String Inverter Clusters",sub:"Grouped inverter clusters",invPer:8},{key:"central",name:"Central Inverters",sub:"Single large central inverter",invPer:16}];
const DCC_OPTS=[{key:"homeruns",name:"String Homeruns",sub:"Direct wire runs from each string"},{key:"harnesses",name:"Harnesses",sub:"Bundled cable assemblies"},{key:"trunk",name:"Trunk Bus",sub:"High-capacity bus system"}];
const DCM_OPTS=[{key:"combiner",name:"Combiner Boxes",sub:"Combine multiple string outputs"},{key:"lbd",name:"LBD's",sub:"Load Break Disconnects"},{key:"none",name:"None",sub:"No DC combination needed"}];
const STEPS=["Module","Inverter","DC Collection","DC Combination"];
function getValid(sel){let r=[...VALID_PATHS];if(sel.module)r=r.filter(p=>p.module===sel.module);if(sel.inverter)r=r.filter(p=>p.inverter===sel.inverter);if(sel.dcCollection)r=r.filter(p=>p.dcCollection===sel.dcCollection);if(sel.dcCombination)r=r.filter(p=>p.dcCombination===sel.dcCombination);return{modules:[...new Set(r.map(p=>p.module))],inverters:[...new Set(r.map(p=>p.inverter))],dcCollections:[...new Set(r.map(p=>p.dcCollection))],dcCombinations:[...new Set(r.map(p=>p.dcCombination))],matched:r.length===1?r[0]:null,remaining:r};}
const T={bg:"#0b1121",bgDeep:"#060b17",card:"#111c32",cardHover:"#162442",cardDisabled:"#0a0f1a",border:"#1c2d4a",borderActive:"#00b8d4",borderDim:"#152238",accent:"#00d4ff",accentGlow:"rgba(0,212,255,0.15)",accentBright:"#00e5ff",text:"#e4eaf6",textSub:"#6b82a8",textDim:"#3d5278",textDisabled:"#2a3a55",pink:"#ff4081",orange:"#ff9100",green:"#00e676",yellow:"#ffea00",red:"#ff5252",purple:"#b388ff",blue:"#448aff",dcColor:"#ff5252",acColor:"#00e676",mvColor:"#b388ff",trunkColor:"#ff9100",font:"'Segoe UI','SF Pro Display',-apple-system,sans-serif",fontMono:"'JetBrains Mono','SF Mono','Cascadia Code',monospace"};

function buildLayout(mt,cfg,sp){const mod=MOD[mt];const{rowLength,postSpacing,rowPitch,blockRows,blockCount}=sp;const invPer=INV_OPTS.find(o=>o.key===cfg.inverter)?.invPer||8;const modStep=mod.h+0.02;const mpr=Math.floor(rowLength/modStep);const spr=Math.floor(mpr/mod.strLen);const am=spr*mod.strLen;const al=am*modStep;const np=Math.max(3,Math.floor(al/postSpacing)+1);const di=Math.floor(np/2);const rkw=am*mod.watt/1000;const bkw=rkw*blockRows;const tmw=(bkw*blockCount)/1000;const ic=cfg.inverter==="central"?blockCount:blockCount*Math.ceil(blockRows/invPer);const rows=[],equip=[],dcR=[],acR=[],mvR=[],roads=[];const eqW=cfg.inverter==="central"?10:cfg.inverter==="cluster"?7:3;const bH=blockRows*rowPitch;const bW=al+eqW+4;const gap=9;const cols=Math.ceil(Math.sqrt(blockCount));const gR=Math.ceil(blockCount/cols);
for(let bi=0;bi<blockCount;bi++){const gc=bi%cols,gr=Math.floor(bi/cols);const bx=gc*(bW+gap),by=gr*(bH+gap);roads.push({x:bx-3,y:by-3,w:bW+6,h:bH+6});for(let ri=0;ri<blockRows;ri++){const ry=by+ri*rowPitch;rows.push({x:bx,y:ry,len:al,mods:am,posts:np,driveIdx:di,block:bi});if(cfg.dcCollection==="harnesses"||cfg.dcCombination==="combiner"){dcR.push({x1:bx,y1:ry,x2:bx+al,y2:ry,t:"harness"});if(ri%4===3||ri===blockRows-1){const cx2=bx+al+2,cy=ry-Math.min(3,ri%4)*rowPitch/2;equip.push({x:cx2,y:cy,t:"combiner",block:bi});for(let d=Math.max(0,ri-3);d<=ri;d++)dcR.push({x1:bx+al,y1:by+d*rowPitch,x2:cx2,y2:cy,t:"drop"});}}else if(cfg.dcCollection==="trunk"||cfg.dcCombination==="lbd"){dcR.push({x1:bx,y1:ry,x2:bx+al,y2:ry,t:"trunk"});if(ri%4===3||ri===blockRows-1)equip.push({x:bx+al+2,y:ry-Math.min(3,ri%4)*rowPitch/2,t:"lbd",block:bi});}else{dcR.push({x1:bx,y1:ry,x2:bx+al,y2:ry,t:"homerun"});}}
if(cfg.inverter==="distributed"){for(let ri=0;ri<blockRows;ri+=invPer){const iy=by+(ri+Math.min(invPer-1,blockRows-ri-1)/2)*rowPitch;equip.push({x:bx+al+2,y:iy,t:"str-inv",block:bi});acR.push({x1:bx+al+2,y1:iy,x2:bx+al+6,y2:iy});}}else if(cfg.inverter==="cluster"){for(let ci=0;ci<Math.ceil(blockRows/invPer);ci++){const iy=by+(ci*invPer+Math.min(invPer,blockRows-ci*invPer)/2)*rowPitch;equip.push({x:bx+al+5,y:iy,t:"clust-inv",block:bi});acR.push({x1:bx+al+5,y1:iy,x2:bx+al+9,y2:iy});}}else{const iy=by+bH/2;equip.push({x:bx+al+6,y:iy,t:"cent-inv",block:bi});equip.push({x:bx+al+6,y:iy+6,t:"mv-xfmr",block:bi});acR.push({x1:bx+al+6,y1:iy,x2:bx+al+6,y2:iy+6});}mvR.push({x1:bx-3,y1:by+bH+1.5,x2:bx+bW+3,y2:by+bH+1.5});}
const subX=(cols*(bW+gap))/2,subY=gR*(bH+gap)+12;equip.push({x:subX,y:subY,t:"substation"});for(let g=0;g<cols;g++)mvR.push({x1:g*(bW+gap)+bW/2,y1:0,x2:g*(bW+gap)+bW/2,y2:subY});return{rows,equip,dcR,acR,mvR,roads,stats:{totalMods:am*blockRows*blockCount,totalStrs:spr*blockRows*blockCount,totMW:tmw,invCnt:ic,blkKW:bkw,modsPerRow:am,strsPerRow:spr,actLen:al,numPosts:np},bounds:{w:cols*(bW+gap),h:gR*(bH+gap)+25}};}

function makeLabel(text,bg,scale){const c=document.createElement("canvas");const x=c.getContext("2d");x.font="bold 48px Arial";const tw=x.measureText(text).width;c.width=tw+40;c.height=72;x.fillStyle=bg;const r=12,w=c.width,h=c.height;x.beginPath();x.moveTo(r,0);x.lineTo(w-r,0);x.quadraticCurveTo(w,0,w,r);x.lineTo(w,h-r);x.quadraticCurveTo(w,h,w-r,h);x.lineTo(r,h);x.quadraticCurveTo(0,h,0,h-r);x.lineTo(0,r);x.quadraticCurveTo(0,0,r,0);x.fill();x.fillStyle="#fff";x.font="bold 48px Arial";x.textAlign="center";x.textBaseline="middle";x.fillText(text,w/2,h/2);const t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearFilter;const m=new THREE.SpriteMaterial({map:t,transparent:true,depthTest:false});const s=new THREE.Sprite(m);s.scale.set((c.width/c.height)*scale*2,scale*2,1);return s;}

function makeBifacialTex(){const c=document.createElement("canvas");c.width=512;c.height=1024;const x=c.getContext("2d");
  x.fillStyle="#0d1520";x.fillRect(0,0,512,1024);
  const cc=6,cr=10,cw=512/cc,ch=1024/cr,gap=3;
  for(let r=0;r<cr;r++)for(let cl=0;cl<cc;cl++){
    const cx=cl*cw+gap,cy=r*ch+gap,w=cw-gap*2,h=ch-gap*2;
    const v=0.85+Math.random()*0.3;
    x.fillStyle="rgb("+Math.floor(22*v)+","+Math.floor(55*v)+","+Math.floor(95*v)+")";
    x.fillRect(cx,cy,w,h);
    for(let g2=0;g2<3;g2++){const gx=cx+Math.random()*w,gy=cy+Math.random()*h;
      const gr=x.createRadialGradient(gx,gy,0,gx,gy,w*0.4);
      gr.addColorStop(0,"rgba(80,130,190,0.12)");gr.addColorStop(1,"rgba(30,60,110,0)");
      x.fillStyle=gr;x.fillRect(cx,cy,w,h);}
    x.strokeStyle="rgba(190,200,215,0.2)";x.lineWidth=0.6;
    for(let f=1;f<8;f++){x.beginPath();x.moveTo(cx+f*(w/8),cy+1);x.lineTo(cx+f*(w/8),cy+h-1);x.stroke();}
  }
  x.strokeStyle="rgba(230,235,240,0.6)";x.lineWidth=3;
  for(let b=1;b<=3;b++){const by=b*(1024/4);x.beginPath();x.moveTo(0,by);x.lineTo(512,by);x.stroke();}
  x.strokeStyle="rgba(215,220,230,0.3)";x.lineWidth=1.5;
  for(let r=0;r<cr;r++)for(let b=1;b<=2;b++){const by=r*ch+b*(ch/3);x.beginPath();x.moveTo(0,by);x.lineTo(512,by);x.stroke();}
  x.strokeStyle="rgba(8,12,20,0.95)";x.lineWidth=gap;
  for(let i=1;i<cc;i++){x.beginPath();x.moveTo(i*cw,0);x.lineTo(i*cw,1024);x.stroke();}
  for(let i=1;i<cr;i++){x.beginPath();x.moveTo(0,i*ch);x.lineTo(512,i*ch);x.stroke();}
  x.fillStyle="rgba(200,210,225,0.3)";
  for(let r=1;r<cr;r++)for(let cl=1;cl<cc;cl++){const px=cl*cw,py=r*ch;x.beginPath();x.moveTo(px,py-4);x.lineTo(px+4,py);x.lineTo(px,py+4);x.lineTo(px-4,py);x.fill();}
  const t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearMipmapLinearFilter;t.anisotropy=4;return t;}

function makeFirstSolarTex(){const c=document.createElement("canvas");c.width=512;c.height=1024;const x=c.getContext("2d");
  x.fillStyle="#0a0a0a";x.fillRect(0,0,512,1024);
  for(let i=0;i<80;i++){const lx=Math.random()*512;
    x.strokeStyle="rgba(20,20,25,"+(0.1+Math.random()*0.15)+")";x.lineWidth=1+Math.random()*3;
    x.beginPath();x.moveTo(lx,0);x.lineTo(lx+Math.random()*6-3,1024);x.stroke();}
  const gr=x.createLinearGradient(0,0,512,1024);
  gr.addColorStop(0,"rgba(30,30,35,0.08)");gr.addColorStop(0.3,"rgba(15,15,18,0.02)");
  gr.addColorStop(0.7,"rgba(25,25,30,0.06)");gr.addColorStop(1,"rgba(10,10,12,0.03)");
  x.fillStyle=gr;x.fillRect(0,0,512,1024);
  x.strokeStyle="rgba(40,40,45,0.3)";x.lineWidth=4;x.strokeRect(4,4,504,1016);
  x.fillStyle="rgba(25,25,28,0.4)";x.fillRect(180,960,150,40);
  const t=new THREE.CanvasTexture(c);t.minFilter=THREE.LinearMipmapLinearFilter;t.anisotropy=4;return t;}

function makeGndTex(){const c=document.createElement("canvas");c.width=512;c.height=512;const x=c.getContext("2d");x.fillStyle="#8a9a5a";x.fillRect(0,0,512,512);for(let i=0;i<12000;i++){const px=Math.random()*512,py=Math.random()*512,v=0.7+Math.random()*0.6;x.fillStyle="rgba("+Math.floor(120*v)+","+Math.floor(135*v)+","+Math.floor(70*v)+",0.4)";x.fillRect(px,py,1+Math.random()*4,1+Math.random()*2);}const t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;return t;}

function build3D(scene,layout,config){
  while(scene.children.length>0)scene.remove(scene.children[0]);
  const ms=MOD[config.module],tubeH=2.1,cx=layout.bounds.w/2,cz=layout.bounds.h/2;

  scene.add(new THREE.Mesh(new THREE.SphereGeometry(600,32,16),new THREE.ShaderMaterial({side:THREE.BackSide,uniforms:{},
    vertexShader:"varying vec3 vP;void main(){vP=(modelMatrix*vec4(position,1.0)).xyz;gl_Position=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.0);}",
    fragmentShader:"varying vec3 vP;void main(){float h=normalize(vP).y;vec3 t=vec3(0.52,0.68,0.88);vec3 ho=vec3(0.82,0.86,0.90);vec3 g=vec3(0.45,0.48,0.32);vec3 c=h>0.0?mix(ho,t,pow(h,0.35)):mix(ho,g,pow(-h,0.6));gl_FragColor=vec4(c,1.0);}"})));

  scene.add(new THREE.AmbientLight(0xd0dce8,0.5));
  scene.add(new THREE.HemisphereLight(0x9bbce0,0x6a7a4a,0.4));
  const sun=new THREE.DirectionalLight(0xfff4e0,1.5);sun.position.set(50,70,25);sun.castShadow=true;sun.shadow.mapSize.set(4096,4096);
  const sc=Math.max(layout.bounds.w,layout.bounds.h)*0.7;sun.shadow.camera.left=-sc;sun.shadow.camera.right=sc;sun.shadow.camera.top=sc;sun.shadow.camera.bottom=-sc;sun.shadow.camera.near=0.5;sun.shadow.camera.far=400;sun.shadow.bias=-0.0003;scene.add(sun);
  const fill=new THREE.DirectionalLight(0xb0c8e0,0.35);fill.position.set(-30,25,-15);scene.add(fill);

  const gS=Math.max(layout.bounds.w,layout.bounds.h)*3+200;const gT=makeGndTex();gT.repeat.set(gS/12,gS/12);
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(gS,gS),new THREE.MeshStandardMaterial({map:gT,roughness:0.92}));
  gnd.rotation.x=-Math.PI/2;gnd.position.y=-0.01;gnd.receiveShadow=true;scene.add(gnd);

  const stl=new THREE.MeshStandardMaterial({color:0xa5a5a5,metalness:0.65,roughness:0.25});
  const stlDk=new THREE.MeshStandardMaterial({color:0x707070,metalness:0.6,roughness:0.3});
  const bolt=new THREE.MeshStandardMaterial({color:0x2a2a2a,metalness:0.9,roughness:0.15});
  const orgM=new THREE.MeshStandardMaterial({color:0xff6600,emissive:0xff4400,emissiveIntensity:0.1,metalness:0.3,roughness:0.5});
  const mtrM=new THREE.MeshStandardMaterial({color:0x1a3a8a,metalness:0.45,roughness:0.35});
  const conc=new THREE.MeshStandardMaterial({color:0x8a8a8a,roughness:0.9});
  const isBifacial=config.module==="bifacial";
  const cTex=isBifacial?makeBifacialTex():makeFirstSolarTex();
  const pnlM=isBifacial
    ?new THREE.MeshStandardMaterial({map:cTex,metalness:0.15,roughness:0.08})
    :new THREE.MeshStandardMaterial({map:cTex,color:0x111111,metalness:0.05,roughness:0.25});
  const glsM=isBifacial
    ?new THREE.MeshStandardMaterial({color:0x88aacc,metalness:0.2,roughness:0.02,transparent:true,opacity:0.1})
    :new THREE.MeshStandardMaterial({color:0x111115,metalness:0.3,roughness:0.05,transparent:true,opacity:0.15});
  const frmM=isBifacial
    ?new THREE.MeshStandardMaterial({color:0xd0d4d8,metalness:0.8,roughness:0.15})
    :new THREE.MeshStandardMaterial({color:0x1a1a1a,metalness:0.5,roughness:0.3});
  const invM=new THREE.MeshStandardMaterial({color:0x2a2a2a,metalness:0.4,roughness:0.5});
  const invGray=new THREE.MeshStandardMaterial({color:0x555555,metalness:0.3,roughness:0.6});
  const ventM=new THREE.MeshStandardMaterial({color:0x1a1a1a,metalness:0.2,roughness:0.8});
  const condM=new THREE.MeshStandardMaterial({color:0x606060,metalness:0.5,roughness:0.4});
  const redC=new THREE.MeshStandardMaterial({color:0xff2200,roughness:0.4,emissive:0xff0000,emissiveIntensity:0.3});
  const bluC=new THREE.MeshStandardMaterial({color:0x2244aa,roughness:0.5,emissive:0x1133aa,emissiveIntensity:0.2});
  const grnC=new THREE.MeshStandardMaterial({color:0x00ff00,emissive:0x006600,emissiveIntensity:0.3,roughness:0.4});
  const jncM=new THREE.MeshStandardMaterial({color:0xffdd00,roughness:0.3,emissive:0xffaa00,emissiveIntensity:0.3});
  const whtM=new THREE.MeshStandardMaterial({color:0xffffff,metalness:0.1,roughness:0.7});
  const capM=new THREE.MeshStandardMaterial({color:0x777777,metalness:0.6,roughness:0.35});
  const tR=0.12;

  const mw=ms.w,mh=ms.h;
  const pGeo=new THREE.BoxGeometry(mh,0.06,mw);
  const gGeo=new THREE.BoxGeometry(mh-0.02,0.003,mw-0.02);

  layout.rows.forEach(row=>{
    const rx=row.x-cx,rz=row.y-cz;
    const g=new THREE.Group();
    const tt=new THREE.Mesh(new THREE.CylinderGeometry(tR,tR,row.len+0.5,12),stl);
    tt.rotation.z=Math.PI/2;tt.position.set(row.len/2,tubeH,0);tt.castShadow=true;g.add(tt);
    const rOff=mw*0.35;
    [-rOff,0,rOff].forEach(zo=>{
      const rl=new THREE.Mesh(new THREE.BoxGeometry(row.len+1,0.05,0.06),stl);
      rl.position.set(row.len/2,tubeH+tR+0.05,zo);rl.castShadow=true;g.add(rl);
    });
    const pStp=row.len/(row.posts-1);
    for(let p=0;p<row.posts;p++){
      const px=p*pStp;const isDr=p===row.driveIdx;const pH=tubeH-0.1;
      const isArr=p%2===0;
      const post=new THREE.Mesh(new THREE.BoxGeometry(0.06,pH,0.08),stl);
      post.position.set(px,pH/2,0);post.castShadow=true;g.add(post);
      if(isArr){
        const clmp=new THREE.Mesh(new THREE.CylinderGeometry(tR+0.03,tR+0.03,0.08,8),stlDk);
        clmp.rotation.z=Math.PI/2;clmp.position.set(px,tubeH,0);g.add(clmp);
        const fanR=0.22;const shape=new THREE.Shape();
        shape.moveTo(0,-fanR);shape.lineTo(0,fanR);shape.absarc(0,0,fanR,Math.PI/2,-Math.PI/2,true);
        const fan=new THREE.Mesh(new THREE.ExtrudeGeometry(shape,{depth:0.015,bevelEnabled:false}),stl);
        fan.rotation.x=Math.PI/2;fan.position.set(px,tubeH,0);g.add(fan);
      }else{
        const nbx=new THREE.Mesh(new THREE.BoxGeometry(0.12,0.16,0.1),stlDk);
        nbx.position.set(px,tubeH,0);g.add(nbx);
        const badge=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.015,10),orgM);
        badge.rotation.x=Math.PI/2;badge.position.set(px,tubeH-0.03,0.07);g.add(badge);
      }
      if(config.inverter==="distributed"&&p%4===1){
        const invY=tubeH*0.42;
        const ib=new THREE.Mesh(new THREE.BoxGeometry(0.14,0.3,0.4),invM);
        ib.position.set(px,invY,0.22);ib.castShadow=true;g.add(ib);
        [0x00ff00,0x00ff00,0xffaa00].forEach((lc,li)=>{
          const led=new THREE.Mesh(new THREE.SphereGeometry(0.012,6,6),new THREE.MeshStandardMaterial({color:lc,emissive:lc,emissiveIntensity:1.0}));
          led.position.set(px,invY+0.08-li*0.05,0.3);g.add(led);
        });
        const rc=new THREE.Mesh(new THREE.CylinderGeometry(0.012,0.012,0.5,6),redC);
        rc.position.set(px,invY+0.35,0.2);g.add(rc);
        const bc=new THREE.Mesh(new THREE.CylinderGeometry(0.012,0.012,0.5,6),bluC);
        bc.position.set(px,invY+0.35,0.18);g.add(bc);
      }
      if(isDr){
        const mc=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.08,0.18,8),mtrM);
        mc.rotation.z=Math.PI/2;mc.position.set(px,tubeH+0.1,0);mc.castShadow=true;g.add(mc);
        const mbx=new THREE.Mesh(new THREE.BoxGeometry(0.14,0.14,0.14),mtrM);
        mbx.position.set(px+0.14,tubeH+0.1,0);g.add(mbx);
        const ra=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.02,0.15),new THREE.MeshStandardMaterial({color:0xcc2222}));
        ra.position.set(px+0.14,tubeH+0.17,0);g.add(ra);
      }
    }
    for(let m=0;m<row.mods;m++){
      const mx=m*(mh+0.02)+mh/2;
      const pn=new THREE.Mesh(pGeo,pnlM);pn.position.set(mx,tubeH+tR+0.08,0);pn.castShadow=true;pn.receiveShadow=true;g.add(pn);
      const gl=new THREE.Mesh(gGeo,glsM);gl.position.set(mx,tubeH+tR+0.113,0);g.add(gl);
      const ft=0.03;
      [-1,1].forEach(dx=>{const e=new THREE.Mesh(new THREE.BoxGeometry(ft,0.065,mw+ft*2),frmM);e.position.set(mx+dx*(mh/2+ft/2),tubeH+tR+0.08,0);g.add(e);});
      [-1,1].forEach(dz=>{const e=new THREE.Mesh(new THREE.BoxGeometry(mh+ft*2,0.065,ft),frmM);e.position.set(mx,tubeH+tR+0.08,dz*(mw/2+ft/2));g.add(e);});
      if(m%4===0){const jb=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.04,0.15),jncM);jb.position.set(mx,tubeH+tR+0.04,0);g.add(jb);}
      if(m>0){[-rOff,rOff].forEach(zo=>{const cl=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.02,0.04),frmM);cl.position.set(mx-mh/2-0.01,tubeH+tR+0.115,zo);g.add(cl);});}
    }
    g.position.set(rx,0,rz);scene.add(g);
  });

  const eqI={combiner:{c:0xcc2222,l:"COMBINER",h:1,w:0.8,d:0.6},"lbd":{c:0xe08020,l:"LBD",h:1,w:0.8,d:0.6},"str-inv":{c:0x00bb55,l:"STRING INV",h:1.5,w:1.2,d:0.6},"clust-inv":{c:0xccbb00,l:"CLUSTER INV",h:2,w:2.5,d:1.5},"cent-inv":{c:0x3366cc,l:"CENTRAL INV",h:3,w:4,d:2.5},"mv-xfmr":{c:0x8855cc,l:"MV XFMR",h:2.2,w:2.5,d:1.8},substation:{c:0x5522aa,l:"SUBSTATION",h:4.5,w:7,d:5}};
  layout.equip.forEach(eq=>{
    const ex=eq.x-cx,ez=eq.y-cz,info=eqI[eq.t];if(!info)return;
    const mat=new THREE.MeshStandardMaterial({color:info.c,roughness:0.5,metalness:0.3});
    const big=["clust-inv","cent-inv","mv-xfmr","substation"].includes(eq.t);
    if(big){const pd=new THREE.Mesh(new THREE.BoxGeometry(info.w+1.5,0.18,info.d+1.5),conc);pd.position.set(ex,0.09,ez);pd.receiveShadow=true;scene.add(pd);}
    const bx=new THREE.Mesh(new THREE.BoxGeometry(info.w,info.h,info.d),mat);bx.position.set(ex,(big?0.18:0)+info.h/2,ez);bx.castShadow=true;scene.add(bx);
    const ed=new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(info.w,info.h,info.d)),new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:0.12}));ed.position.copy(bx.position);scene.add(ed);
    if(eq.t==="mv-xfmr")[-1,1].forEach(f=>{const fn=new THREE.Mesh(new THREE.BoxGeometry(0.08,1.6,info.d+0.4),mat);fn.position.set(ex+f*(info.w/2+0.15),1.0,ez);scene.add(fn);});
    if(eq.t==="substation"){const fm=new THREE.MeshStandardMaterial({color:0x777777,metalness:0.5,roughness:0.3});for(let fx=-(info.w/2+1.5);fx<=info.w/2+1.5;fx+=1.2)[-1,1].forEach(fz=>{const fp=new THREE.Mesh(new THREE.BoxGeometry(0.05,3,0.05),fm);fp.position.set(ex+fx,1.5,ez+fz*(info.d/2+1.2));scene.add(fp);});[0.8,1.6,2.4].forEach(fy=>[-1,1].forEach(fz=>{const wr=new THREE.Mesh(new THREE.BoxGeometry(info.w+3.2,0.015,0.015),fm);wr.position.set(ex,fy,ez+fz*(info.d/2+1.2));scene.add(wr);}));}
    const cc2=info.c;const lb=makeLabel(info.l,"rgba("+(cc2>>16&0xff)+","+(cc2>>8&0xff)+","+(cc2&0xff)+",0.85)",eq.t==="substation"?2.5:big?1.8:1);lb.position.set(ex,info.h+(big?1.5:0.8),ez);scene.add(lb);
  });

  layout.dcR.forEach(r=>{const c=r.t==="trunk"?0xff9100:r.t==="homerun"?0x607080:0xff4444;scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(r.x1-cx,.04,r.y1-cz),new THREE.Vector3(r.x2-cx,.04,r.y2-cz)]),new THREE.LineBasicMaterial({color:c})));});
  layout.acR.forEach(r=>scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(r.x1-cx,.06,r.y1-cz),new THREE.Vector3(r.x2-cx,.06,r.y2-cz)]),new THREE.LineBasicMaterial({color:0x00cc66}))));
  layout.mvR.forEach(r=>scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(r.x1-cx,.05,r.y1-cz),new THREE.Vector3(r.x2-cx,.05,r.y2-cz)]),new THREE.LineBasicMaterial({color:0x9955ee}))));

  const rdM=new THREE.MeshStandardMaterial({color:0x6a6a55,roughness:0.85});
  layout.roads.forEach(r=>{[{x:r.x+r.w/2,z:r.y,w:r.w+2,d:1.8},{x:r.x+r.w/2,z:r.y+r.h,w:r.w+2,d:1.8},{x:r.x,z:r.y+r.h/2,w:1.8,d:r.h},{x:r.x+r.w,z:r.y+r.h/2,w:1.8,d:r.h}].forEach(rd=>{const m=new THREE.Mesh(new THREE.BoxGeometry(rd.w,.03,rd.d),rdM);m.position.set(rd.x-cx,.015,rd.z-cz);m.receiveShadow=true;scene.add(m);});});

  new Set(layout.rows.map(r=>r.block)).forEach(bi=>{const bR=layout.rows.filter(r=>r.block===bi);const l=makeLabel("BLOCK "+(bi+1),"rgba(0,180,220,0.7)",2);l.position.set((Math.min(...bR.map(r=>r.x))+Math.max(...bR.map(r=>r.x+r.len)))/2-cx,8,(Math.min(...bR.map(r=>r.y))+Math.max(...bR.map(r=>r.y)))/2-cz);scene.add(l);});

  const cg=new THREE.Group();const cArr=new THREE.Mesh(new THREE.CylinderGeometry(0,0.5,2,4),new THREE.MeshStandardMaterial({color:0xff3333}));cArr.rotation.x=-Math.PI/2;cArr.position.z=-1;cg.add(cArr);
  const nL=makeLabel("N","#ff3333",1.2);nL.position.set(0,0.5,-2.5);cg.add(nL);cg.position.set(-cx-8,3,-cz-8);scene.add(cg);
}

function Scene3D({layout,config,sp,camRef}){
  const mR=useRef(null),rR=useRef(null),fR=useRef(null);
  const cam=camRef;
  const ms2=useRef({down:false,btn:-1,lx:0,ly:0});
  useEffect(()=>{
    const el=mR.current;if(!el)return;const w=el.clientWidth,h=el.clientHeight;
    const sc=new THREE.Scene();const ca=new THREE.PerspectiveCamera(50,w/h,0.1,1500);
    cam.current.dist=Math.max(30,Math.min(layout.bounds.w,layout.bounds.h)*0.7);
    const rn=new THREE.WebGLRenderer({antialias:true});rn.setSize(w,h);rn.setPixelRatio(Math.min(window.devicePixelRatio,2));rn.shadowMap.enabled=true;rn.shadowMap.type=THREE.PCFSoftShadowMap;rn.toneMapping=THREE.ACESFilmicToneMapping;rn.toneMappingExposure=1.2;
    el.appendChild(rn.domElement);rR.current=rn;build3D(sc,layout,config);
    const oD=e=>{ms2.current={down:true,btn:e.button,lx:e.clientX,ly:e.clientY};};
    const oM=e=>{if(!ms2.current.down)return;const dx=e.clientX-ms2.current.lx,dy=e.clientY-ms2.current.ly;ms2.current.lx=e.clientX;ms2.current.ly=e.clientY;
      if(ms2.current.btn===0){cam.current.theta-=dx*0.004;cam.current.phi=Math.max(0.05,Math.min(Math.PI/2-0.02,cam.current.phi-dy*0.004));}
      else{const s2=cam.current.dist*0.0015;const st=Math.sin(cam.current.theta),ct=Math.cos(cam.current.theta);cam.current.tx+=(-dx*ct-dy*st*Math.cos(cam.current.phi))*s2;cam.current.tz+=(-dx*st+dy*ct*Math.cos(cam.current.phi))*s2;cam.current.ty=Math.max(0,cam.current.ty+dy*Math.sin(cam.current.phi)*s2);}};
    const oU=()=>{ms2.current.down=false;};const oW=e=>{e.preventDefault();cam.current.dist=Math.max(3,Math.min(400,cam.current.dist*(1+e.deltaY*0.001)));};const oC=e=>e.preventDefault();
    const oTS=e=>{if(e.touches.length===1)ms2.current={down:true,btn:0,lx:e.touches[0].clientX,ly:e.touches[0].clientY};};
    const oTM=e=>{if(!ms2.current.down||e.touches.length!==1)return;const dx=e.touches[0].clientX-ms2.current.lx,dy=e.touches[0].clientY-ms2.current.ly;ms2.current.lx=e.touches[0].clientX;ms2.current.ly=e.touches[0].clientY;cam.current.theta-=dx*0.004;cam.current.phi=Math.max(0.05,Math.min(Math.PI/2-0.02,cam.current.phi-dy*0.004));};
    const oTE=()=>{ms2.current.down=false;};
    const de=rn.domElement;de.addEventListener("mousedown",oD);de.addEventListener("mousemove",oM);de.addEventListener("mouseup",oU);de.addEventListener("mouseleave",oU);de.addEventListener("wheel",oW,{passive:false});de.addEventListener("contextmenu",oC);de.addEventListener("touchstart",oTS);de.addEventListener("touchmove",oTM);de.addEventListener("touchend",oTE);
    const anim=()=>{fR.current=requestAnimationFrame(anim);const c=cam.current;ca.position.x=c.tx+c.dist*Math.sin(c.phi)*Math.cos(c.theta);ca.position.y=c.ty+c.dist*Math.cos(c.phi);ca.position.z=c.tz+c.dist*Math.sin(c.phi)*Math.sin(c.theta);ca.lookAt(c.tx,c.ty,c.tz);rn.render(sc,ca);};anim();
    const oR=()=>{const nw=el.clientWidth,nh=el.clientHeight;ca.aspect=nw/nh;ca.updateProjectionMatrix();rn.setSize(nw,nh);};window.addEventListener("resize",oR);
    return()=>{cancelAnimationFrame(fR.current);window.removeEventListener("resize",oR);de.removeEventListener("mousedown",oD);de.removeEventListener("mousemove",oM);de.removeEventListener("mouseup",oU);de.removeEventListener("mouseleave",oU);de.removeEventListener("wheel",oW);de.removeEventListener("contextmenu",oC);de.removeEventListener("touchstart",oTS);de.removeEventListener("touchmove",oTM);de.removeEventListener("touchend",oTE);el.removeChild(rn.domElement);rn.dispose();};
  },[layout,config,sp]);
  return <div ref={mR} style={{width:"100%",height:"100%"}} />;
}

function ConfigWizard({onComplete}){
  const[sel,setSel]=useState({module:null,inverter:null,dcCollection:null,dcCombination:null});const valid=getValid(sel);const cnt=Object.values(sel).filter(Boolean).length;const curStep=!sel.module?0:!sel.inverter?1:!sel.dcCollection?2:!sel.dcCombination?3:4;
  const pick=(cat,val)=>{const n={...sel};n[cat]=sel[cat]===val?null:val;if(cat==="module"){n.inverter=null;n.dcCollection=null;n.dcCombination=null;}if(cat==="inverter"){n.dcCollection=null;n.dcCombination=null;}if(cat==="dcCollection"){n.dcCombination=null;}setSel(n);};
  const reset=()=>setSel({module:null,inverter:null,dcCollection:null,dcCombination:null});const ok=cnt===4&&valid.matched;
  return(
    <div style={{width:"100%",height:"100vh",background:T.bgDeep,display:"flex",alignItems:"center",justifyContent:"center",fontFamily:T.font,overflow:"auto",padding:20}}>
      <div style={{position:"fixed",top:"30%",left:"50%",width:600,height:600,background:"radial-gradient(circle,rgba(0,180,220,0.04)0%,transparent 70%)",transform:"translate(-50%,-50%)",pointerEvents:"none"}} />
      <div style={{width:"100%",maxWidth:720,background:T.card,borderRadius:16,border:"2px solid "+T.borderActive,boxShadow:"0 0 60px rgba(0,180,220,0.08),0 20px 60px rgba(0,0,0,0.5)",position:"relative",overflow:"hidden"}}>
        <div style={{position:"absolute",top:0,left:"10%",right:"10%",height:1,background:"linear-gradient(90deg,transparent,"+T.accentBright+",transparent)"}} />
        <div style={{padding:"28px 32px 0",textAlign:"center"}}>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:8}}>
            <div style={{width:36,height:36,borderRadius:8,background:"linear-gradient(135deg,#ff4081,#ff9100)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,fontWeight:800,color:"#fff",boxShadow:"0 4px 15px rgba(255,64,129,0.3)"}}>E</div>
            <span style={{fontSize:22,fontWeight:700,color:T.pink}}>Create a Site</span></div>
          <p style={{fontSize:13,color:T.textSub,margin:"0 0 20px"}}>Select your solar site configuration — invalid options are automatically disabled</p>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",marginBottom:24}}>
            {STEPS.map((s,i)=>{const done=(i===0&&sel.module)||(i===1&&sel.inverter)||(i===2&&sel.dcCollection)||(i===3&&sel.dcCombination);const active=i===curStep;
              return(<div key={s} style={{display:"flex",alignItems:"center"}}><div style={{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:20,background:done?T.accentGlow:active?"rgba(255,255,255,0.04)":"transparent",border:"1px solid "+(done?T.accent:active?T.borderActive:"transparent")}}><div style={{width:8,height:8,borderRadius:"50%",background:done?T.accent:active?T.accent:T.textDim,boxShadow:done?"0 0 8px "+T.accent:"none"}} /><span style={{fontSize:11,fontWeight:600,color:done?T.accent:active?T.text:T.textDim}}>{s}</span></div>{i<3&&<div style={{width:20,height:1,background:done?T.accent:T.borderDim,margin:"0 2px"}} />}</div>);})}
          </div></div>
        <div style={{padding:"0 28px 20px",display:"flex",flexDirection:"column",gap:20}}>
          <Cat title="MODULE / STRING SIZE"><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>{Object.entries(MOD).map(([k,v])=><Opt key={k} name={v.name} sub={v.sub} sel={sel.module===k} dis={!valid.modules.includes(k)&&sel.module!==k} onClick={()=>pick("module",k)} />)}</div></Cat>
          <Cat title="INVERTER TYPE"><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>{INV_OPTS.map(o=><Opt key={o.key} name={o.name} sub={o.sub} sel={sel.inverter===o.key} dis={!valid.inverters.includes(o.key)&&sel.inverter!==o.key} onClick={()=>pick("inverter",o.key)} />)}</div></Cat>
          <Cat title="DC COLLECTION"><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>{DCC_OPTS.map(o=><Opt key={o.key} name={o.name} sub={o.sub} sel={sel.dcCollection===o.key} dis={!valid.dcCollections.includes(o.key)&&sel.dcCollection!==o.key} onClick={()=>pick("dcCollection",o.key)} />)}</div></Cat>
          <Cat title="DC COMBINATION"><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}>{DCM_OPTS.map(o=><Opt key={o.key} name={o.name} sub={o.sub} sel={sel.dcCombination===o.key} dis={!valid.dcCombinations.includes(o.key)&&sel.dcCombination!==o.key} onClick={()=>pick("dcCombination",o.key)} />)}</div></Cat>
        </div>
        <div style={{padding:"16px 28px 24px",borderTop:"1px solid "+T.borderDim,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <span style={{fontSize:13,color:T.textSub}}><span style={{color:T.text,fontWeight:600}}>{cnt}</span> of 4 selected</span>
          <div style={{display:"flex",gap:10}}>
            <button onClick={reset} style={{padding:"9px 20px",borderRadius:8,border:"1px solid "+T.border,background:"transparent",color:T.textSub,cursor:"pointer",fontFamily:T.font,fontSize:13}}>&#x21bb; Start Over</button>
            <button onClick={()=>ok&&onComplete(sel,valid.matched)} disabled={!ok} style={{padding:"9px 28px",borderRadius:8,border:"none",background:ok?"linear-gradient(135deg,"+T.accent+","+T.blue+")":T.cardDisabled,color:ok?"#000":T.textDisabled,cursor:ok?"pointer":"not-allowed",fontFamily:T.font,fontSize:13,fontWeight:700,boxShadow:ok?"0 4px 20px rgba(0,212,255,0.25)":"none"}}>Build Site &#x2192;</button>
          </div></div>
      </div></div>);
}
function Cat({title,children}){return <div><div style={{fontSize:12,fontWeight:700,color:T.orange,letterSpacing:"0.8px",marginBottom:10}}>&#x25B8; {title}</div>{children}</div>;}
function Opt({name,sub,sel,dis,onClick}){const[h,setH]=useState(false);const d=dis&&!sel;return(<button onClick={d?undefined:onClick} onMouseEnter={()=>setH(true)} onMouseLeave={()=>setH(false)} style={{padding:14,borderRadius:10,border:"1.5px solid "+(sel?T.borderActive:d?T.borderDim:h?"rgba(0,212,255,0.3)":T.border),background:sel?"linear-gradient(135deg,rgba(0,180,220,0.12),rgba(0,212,255,0.06))":d?T.cardDisabled:h?T.cardHover:T.bg,cursor:d?"not-allowed":"pointer",textAlign:"center",fontFamily:T.font,opacity:d?0.35:1,boxShadow:sel?"0 0 20px rgba(0,212,255,0.08)":"none",position:"relative",overflow:"hidden",transition:"all 0.2s"}}>{sel&&<div style={{position:"absolute",top:0,left:"20%",right:"20%",height:1,background:"linear-gradient(90deg,transparent,"+T.accent+",transparent)"}} />}<div style={{fontSize:13,fontWeight:600,color:sel?T.text:d?T.textDisabled:T.text,marginBottom:4,lineHeight:"1.3"}}>{name}</div><div style={{fontSize:10,color:sel?T.textSub:d?T.textDisabled:T.textDim,lineHeight:"1.3"}}>{sub}</div></button>);}

function SiteDesigner({config,matched,onBack}){
  const[sp,setSp]=useState({rowLength:140,postSpacing:7,rowPitch:6.5,blockRows:12,blockCount:4});const[sideTab,setSideTab]=useState("layout");const[showLeg,setShowLeg]=useState(true);
  const[compassAngle,setCompassAngle]=useState(Math.PI/5);
  const camRef=useRef({theta:Math.PI/5,phi:Math.PI/4,dist:60,tx:0,ty:3,tz:0});
  const animRef=useRef(null);
  useEffect(()=>{const iv=setInterval(()=>setCompassAngle(camRef.current.theta),50);return()=>clearInterval(iv);},[]);
  const goDir=useCallback((theta,phi)=>{
    if(animRef.current)cancelAnimationFrame(animRef.current);
    const c=camRef.current,st=c.theta,sp2=c.phi,steps=30;let i=0;
    const dT=((((theta-st)%(Math.PI*2))+(Math.PI*3))%(Math.PI*2))-Math.PI;
    const step=()=>{i++;const t=1-Math.pow(1-i/steps,3);
      c.theta=st+dT*t;c.phi=sp2+(phi-sp2)*t;
      if(i<steps)animRef.current=requestAnimationFrame(step);};step();
  },[]);
  const layout=useMemo(()=>buildLayout(config.module,config,sp),[config,sp]);const up=(k,v)=>setSp(p=>({...p,[k]:v}));
  const clsC=matched.cls==="A"?T.green:matched.cls==="B"?T.yellow:T.blue;
  return(
    <div style={{width:"100%",height:"100vh",background:T.bgDeep,fontFamily:T.font,color:T.text,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px",borderBottom:"1px solid "+T.border,flexShrink:0,background:T.card}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <button onClick={onBack} style={{background:T.bg,border:"1px solid "+T.border,color:T.textSub,borderRadius:6,padding:"5px 12px",cursor:"pointer",fontFamily:T.font,fontSize:11}}>&#x2190; Config</button>
          <span style={{fontSize:13,fontWeight:700}}>{matched.id}</span>
          <span style={{fontSize:10,padding:"2px 8px",borderRadius:4,background:clsC,color:"#000",fontWeight:800}}>CLASS {matched.cls}</span>
          <span style={{fontSize:11,color:T.textSub}}>{MOD[config.module].name} &middot; {config.inverter==="distributed"?"Distributed":config.inverter==="cluster"?"Cluster":"Central"} &middot; {config.dcCollection==="homeruns"?"Homeruns":config.dcCollection==="harnesses"?"Harness":"Trunk Bus"}</span>
        </div>
        <div style={{display:"flex",gap:20,fontSize:10,fontFamily:T.fontMono}}>
          {[{l:"MODULES",v:layout.stats.totalMods.toLocaleString()},{l:"CAPACITY",v:layout.stats.totMW.toFixed(1)+" MW",c:T.accent},{l:"INVERTERS",v:layout.stats.invCnt},{l:"BLOCKS",v:sp.blockCount}].map(x=>(
            <div key={x.l} style={{textAlign:"center"}}><div style={{color:T.textDim,letterSpacing:"0.5px"}}>{x.l}</div><div style={{color:x.c||T.text,fontWeight:700,fontSize:14}}>{x.v}</div></div>))}
        </div>
      </div>
      <div style={{display:"flex",flex:1,overflow:"hidden"}}>
        <div style={{flex:1,position:"relative"}}><Scene3D layout={layout} config={config} sp={sp} camRef={camRef} />
          <div style={{position:"absolute",top:12,left:12,background:"rgba(6,11,23,0.88)",backdropFilter:"blur(10px)",borderRadius:10,padding:"10px 14px",border:"1px solid "+T.border,fontSize:11,color:T.textSub,lineHeight:"1.6"}}>
            <div style={{fontWeight:700,color:T.text,marginBottom:4,fontSize:12}}>Navigation</div>
            <div>Left-drag &#x2192; <span style={{color:T.accent}}>Orbit</span></div><div>Right-drag &#x2192; <span style={{color:T.accent}}>Pan</span></div><div>Scroll &#x2192; <span style={{color:T.accent}}>Zoom</span></div>
          </div>
          <div style={{position:"absolute",bottom:12,left:12,background:"rgba(6,11,23,0.92)",backdropFilter:"blur(10px)",borderRadius:10,padding:showLeg?"12px 14px":"8px 12px",border:"1px solid "+T.border,fontSize:10,transition:"all 0.2s"}}>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,cursor:"pointer"}} onClick={()=>setShowLeg(v=>!v)}>
              <div style={{fontWeight:700,color:T.textDim,fontSize:9,letterSpacing:"1px"}}>3D LEGEND</div>
              <div style={{fontSize:10,color:T.textSub,width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:4,background:"rgba(255,255,255,0.06)",border:"1px solid "+T.borderDim}}>{showLeg?"&#x25BE;":"&#x25B8;"}</div>
            </div>
            {showLeg&&<div style={{marginTop:6}}>
            {[config.module==="bifacial"?{c:"#1c3a60",l:"Bifacial Panels (blue cells + busbars)"}:{c:"#111111",l:"First Solar Panels (black thin film)"},{c:"#ff6600",l:"Nextracker Orange Badge"},{c:"#a5a5a5",l:"Array Tech Fan Plate"},{c:"#1a3a8a",l:"Drive Motor (blue)"},{c:"#a5a5a5",l:"W-Beam Steel Posts"},
              config.inverter==="distributed"&&{c:"#2a2a2a",l:"String Inverter (LEDs)"},
              config.dcCombination==="combiner"&&{c:"#cc2222",l:"Combiner Box"},config.dcCombination==="lbd"&&{c:"#e08020",l:"LBD"},
              config.inverter==="cluster"&&{c:"#ccbb00",l:"Cluster Inverter"},config.inverter==="central"&&{c:"#3366cc",l:"Central Inverter"},
              config.inverter==="central"&&{c:"#8855cc",l:"MV Transformer"},{c:"#5522aa",l:"Substation"},{c:"#6a6a55",l:"Service Roads"},
              {c:"#ff2200",l:"DC+ Cable (red)"},{c:"#2244aa",l:"DC- Cable (blue)"},{c:"#00ff00",l:"Ground Wire (green)"}
            ].filter(Boolean).map((it,i)=>(<div key={i} style={{display:"flex",alignItems:"center",gap:7,marginTop:4}}><div style={{width:12,height:12,borderRadius:3,background:it.c,border:"1px solid rgba(255,255,255,0.1)",flexShrink:0}} /><span style={{color:T.textSub}}>{it.l}</span></div>))}
            </div>}
          </div>
          <div style={{position:"absolute",top:8,right:8,userSelect:"none"}}>
            <svg width="140" height="140" viewBox="-70 -70 140 140" style={{filter:"drop-shadow(0 4px 12px rgba(0,0,0,0.5))"}}>
              <circle cx="0" cy="0" r="65" fill="rgba(6,11,23,0.92)" stroke="rgba(28,45,74,0.8)" strokeWidth="1.5"/>
              <circle cx="0" cy="0" r="58" fill="none" stroke="rgba(0,212,255,0.12)" strokeWidth="0.5"/>
              {Array.from({length:36}).map((_,i)=>{const a=i*10*Math.PI/180;const inner=i%9===0?48:i%3===0?53:56;return <line key={i} x1={Math.sin(a)*inner} y1={-Math.cos(a)*inner} x2={Math.sin(a)*60} y2={-Math.cos(a)*60} stroke={i%9===0?"rgba(0,212,255,0.5)":"rgba(100,130,170,0.25)"} strokeWidth={i%9===0?1.5:0.5}/>})}
              <g transform={`rotate(${compassAngle*180/Math.PI})`}>
                <polygon points="0,-46 -6,-8 0,-14 6,-8" fill="#ff3344" opacity="0.9"/>
                <polygon points="0,46 -6,8 0,14 6,8" fill="#556680" opacity="0.7"/>
                <line x1="-42" y1="0" x2="-10" y2="0" stroke="rgba(100,130,170,0.3)" strokeWidth="1"/>
                <line x1="10" y1="0" x2="42" y2="0" stroke="rgba(100,130,170,0.3)" strokeWidth="1"/>
                {[45,135,225,315].map(a=>{const r1=12,r2=38,rad=a*Math.PI/180;return <line key={a} x1={Math.sin(rad)*r1} y1={-Math.cos(rad)*r1} x2={Math.sin(rad)*r2} y2={-Math.cos(rad)*r2} stroke="rgba(100,130,170,0.15)" strokeWidth="0.5"/>})}
                <polygon points="0,-6 6,0 0,6 -6,0" fill="rgba(0,212,255,0.3)" stroke="rgba(0,212,255,0.5)" strokeWidth="0.5"/>
              </g>
              <g style={{cursor:"pointer"}} onClick={()=>goDir(-Math.PI/2,Math.PI/5)}>
                <circle cx="0" cy="-52" r="10" fill="rgba(255,51,68,0.15)" stroke="rgba(255,51,68,0.4)" strokeWidth="0.8"/>
                <text x="0" y="-48" textAnchor="middle" fill="#ff3344" fontSize="11" fontWeight="800" fontFamily={T.font}>N</text>
              </g>
              <g style={{cursor:"pointer"}} onClick={()=>goDir(Math.PI/2,Math.PI/5)}>
                <circle cx="0" cy="52" r="10" fill="rgba(255,255,255,0.04)" stroke="rgba(100,130,170,0.3)" strokeWidth="0.5"/>
                <text x="0" y="56" textAnchor="middle" fill="#6b82a8" fontSize="10" fontWeight="700" fontFamily={T.font}>S</text>
              </g>
              <g style={{cursor:"pointer"}} onClick={()=>goDir(0,Math.PI/5)}>
                <circle cx="52" cy="0" r="10" fill="rgba(255,255,255,0.04)" stroke="rgba(100,130,170,0.3)" strokeWidth="0.5"/>
                <text x="52" y="4" textAnchor="middle" fill="#6b82a8" fontSize="10" fontWeight="700" fontFamily={T.font}>E</text>
              </g>
              <g style={{cursor:"pointer"}} onClick={()=>goDir(Math.PI,Math.PI/5)}>
                <circle cx="-52" cy="0" r="10" fill="rgba(255,255,255,0.04)" stroke="rgba(100,130,170,0.3)" strokeWidth="0.5"/>
                <text x="-52" y="4" textAnchor="middle" fill="#6b82a8" fontSize="10" fontWeight="700" fontFamily={T.font}>W</text>
              </g>
              <g style={{cursor:"pointer"}} onClick={()=>goDir(camRef.current.theta,0.08)}>
                <circle cx="0" cy="0" r="8" fill="rgba(0,212,255,0.1)" stroke="rgba(0,212,255,0.4)" strokeWidth="0.8"/>
                <circle cx="0" cy="0" r="3" fill="rgba(0,212,255,0.5)"/>
              </g>
              <text x="0" y="38" textAnchor="middle" fill="rgba(0,212,255,0.5)" fontSize="7" fontFamily={T.fontMono}>{(((compassAngle*180/Math.PI)%360+360)%360).toFixed(0)}°</text>
            </svg>
          </div>
        </div>
        <div style={{width:300,flexShrink:0,background:T.card,borderLeft:"1px solid "+T.border,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{display:"flex",borderBottom:"1px solid "+T.border,flexShrink:0}}>
            {["layout","elec","stats"].map(tab=>(<button key={tab} onClick={()=>setSideTab(tab)} style={{flex:1,padding:8,border:"none",background:sideTab===tab?T.bgDeep:"transparent",color:sideTab===tab?T.accent:T.textDim,fontSize:9,fontWeight:700,letterSpacing:"1px",textTransform:"uppercase",cursor:"pointer",fontFamily:T.fontMono,borderBottom:sideTab===tab?"2px solid "+T.accent:"2px solid transparent"}}>{tab==="layout"?"LAYOUT":tab==="elec"?"ELECTRICAL":"STATS"}</button>))}
          </div>
          <div style={{flex:1,overflow:"auto",padding:14}}>
            {sideTab==="layout"&&(<div style={{display:"flex",flexDirection:"column",gap:12}}>
              <SL>ROW GEOMETRY</SL><Sli label="Row Length (m)" value={sp.rowLength} min={60} max={300} step={5} onChange={v=>up("rowLength",v)} />
              <Sli label="Post Spacing (m)" value={sp.postSpacing} min={4} max={10} step={0.5} onChange={v=>up("postSpacing",v)} />
              <Sli label="Row Pitch (m)" value={sp.rowPitch} min={4} max={10} step={0.5} onChange={v=>up("rowPitch",v)} />
              <SL>BLOCK STRUCTURE</SL><Sli label="Rows per Block" value={sp.blockRows} min={6} max={20} step={1} onChange={v=>up("blockRows",v)} />
              <Sli label="Block Count" value={sp.blockCount} min={1} max={12} step={1} onChange={v=>up("blockCount",v)} />
              <div style={{padding:10,borderRadius:6,background:T.bgDeep,border:"1px solid "+T.border,fontSize:10,color:T.textSub,lineHeight:"1.6"}}><span style={{color:T.accent,fontWeight:700}}>&#x2139; </span>Components match the Ampacity Renewables style: W-beam posts, alternating Array Tech fan plates &amp; Nextracker orange badges, cylindrical torque tubes, teal cell panels with busbars, string inverters with LEDs.</div>
            </div>)}
            {sideTab==="elec"&&(<div style={{display:"flex",flexDirection:"column",gap:12}}>
              <SL>CONFIGURATION</SL><div style={{padding:10,borderRadius:8,border:"1px solid "+clsC,background:clsC+"11"}}><div style={{fontWeight:700,fontSize:12}}>{matched.id} — Class {matched.cls}</div><div style={{fontSize:10,color:T.textSub,marginTop:4}}>{MOD[config.module].name}</div></div>
              <SL>HIERARCHY</SL><Chain config={config} />
              <SL>TOPOLOGY</SL><IR label="DC Collection" value={config.dcCollection==="homeruns"?"String Homeruns":config.dcCollection==="harnesses"?"Harnesses":"Trunk Bus"} />
              <IR label="DC Combination" value={config.dcCombination==="none"?"None":config.dcCombination==="combiner"?"Combiner Boxes":"LBDs"} />
              <IR label="Inverter" value={config.inverter==="distributed"?"Distributed":config.inverter==="cluster"?"Cluster":"Central"} />
              <SL>HARD CONSTRAINTS</SL><div style={{padding:10,borderRadius:6,background:"rgba(255,82,82,0.05)",border:"1px solid rgba(255,82,82,0.15)",fontSize:10,color:T.textSub,lineHeight:"1.7"}}>No harness + trunk bus mixing<br/>No LBDs without trunk bus<br/>No string homeruns for First Solar<br/>No DC equipment inline with trackers<br/>String lengths locked</div>
            </div>)}
            {sideTab==="stats"&&(<div style={{display:"flex",flexDirection:"column",gap:10}}>
              <SL>SITE SUMMARY</SL><SR label="Total Capacity" value={layout.stats.totMW.toFixed(2)+" MW"} accent /><SR label="Total Modules" value={layout.stats.totalMods.toLocaleString()} /><SR label="Total Strings" value={layout.stats.totalStrs.toLocaleString()} /><SR label="Inverters" value={layout.stats.invCnt} />
              <SL>PER ROW</SL><SR label="Modules / Row" value={layout.stats.modsPerRow} /><SR label="Strings / Row" value={layout.stats.strsPerRow} /><SR label="Row Length" value={layout.stats.actLen.toFixed(1)+" m"} /><SR label="Posts / Row" value={layout.stats.numPosts} />
              <SL>PER BLOCK</SL><SR label="Block Power" value={layout.stats.blkKW.toFixed(0)+" kW"} /><SR label="Rows / Block" value={sp.blockRows} />
              <SL>MODULE</SL><SR label="Type" value={MOD[config.module].name} /><SR label="Rating" value={MOD[config.module].watt+"W"} /><SR label="String Length" value={MOD[config.module].strLen+" modules"} />
            </div>)}
          </div>
        </div>
      </div>
    </div>);
}
function SL({children}){return <div style={{fontSize:9,color:T.textDim,letterSpacing:"1px",fontWeight:700,fontFamily:T.fontMono,marginTop:4}}>{children}</div>;}
function IR({label,value}){return <div style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid "+T.borderDim,fontSize:11}}><span style={{color:T.textSub}}>{label}</span><span style={{color:T.text,fontWeight:600}}>{value}</span></div>;}
function SR({label,value,accent}){return <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"7px 10px",borderRadius:6,background:T.bgDeep,border:"1px solid "+T.borderDim}}><span style={{fontSize:10,color:T.textDim,fontFamily:T.fontMono}}>{label}</span><span style={{fontSize:accent?14:12,fontWeight:700,color:accent?T.accent:T.text,fontFamily:T.fontMono}}>{value}</span></div>;}
function Chain({config}){const s=["MODULE","STRING"];if(config.dcCollection==="harnesses")s.push("HARNESS");if(config.dcCollection==="trunk")s.push("TRUNK BUS");if(config.dcCombination==="combiner")s.push("COMBINER");if(config.dcCombination==="lbd")s.push("LBD");s.push(config.inverter==="distributed"?"STR INV":config.inverter==="cluster"?"CLUST INV":"CENT INV");s.push("MV XFMR","MV COLL","SUBSTATION");const cm={MODULE:"#64748b",STRING:"#94a3b8",HARNESS:T.dcColor,"TRUNK BUS":T.trunkColor,COMBINER:T.dcColor,LBD:T.trunkColor,"STR INV":T.green,"CLUST INV":T.yellow,"CENT INV":T.blue,"MV XFMR":T.mvColor,"MV COLL":T.mvColor,SUBSTATION:"#7c3aed"};return(<div style={{display:"flex",flexWrap:"wrap",gap:3,alignItems:"center"}}>{s.map((x,i)=>(<div key={i} style={{display:"flex",alignItems:"center",gap:3}}><span style={{fontSize:8,fontWeight:700,padding:"2px 5px",borderRadius:3,background:cm[x]||T.textDim,color:"#000",whiteSpace:"nowrap"}}>{x}</span>{i<s.length-1&&<span style={{color:T.textDim,fontSize:9}}>&#x2192;</span>}</div>))}</div>);}
function Sli({label,value,min,max,step,onChange}){const pct=((value-min)/(max-min))*100;return(<div><div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}><span style={{fontSize:10,color:T.textSub}}>{label}</span><span style={{fontSize:10,color:T.accent,fontWeight:600,fontFamily:T.fontMono}}>{Number.isInteger(step)?value:value.toFixed(1)}</span></div><div style={{position:"relative",height:18,display:"flex",alignItems:"center"}}><div style={{position:"absolute",width:"100%",height:3,background:T.borderDim,borderRadius:2}} /><div style={{position:"absolute",width:pct+"%",height:3,background:T.accent,borderRadius:2}} /><input type="range" min={min} max={max} step={step} value={value} onChange={e=>onChange(parseFloat(e.target.value))} style={{position:"absolute",width:"100%",height:18,opacity:0,cursor:"pointer",margin:0}} /><div style={{position:"absolute",left:"calc("+pct+"% - 6px)",width:12,height:12,borderRadius:"50%",background:T.accent,border:"2px solid "+T.bgDeep,pointerEvents:"none",boxShadow:"0 0 6px rgba(0,212,255,0.3)"}} /></div></div>);}

function App(){const[view,setView]=useState("wizard");const[config,setConfig]=useState(null);const[matched,setMatched]=useState(null);
  if(view==="wizard"||!config)return <ConfigWizard onComplete={(c,m)=>{setConfig(c);setMatched(m);setView("site");}} />;
  return <SiteDesigner config={config} matched={matched} onBack={()=>{setView("wizard");setConfig(null);setMatched(null);}} />;}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>